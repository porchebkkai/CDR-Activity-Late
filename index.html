<!doctype html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart CDR System - Iqra Muslim School</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');

        body {
            box-sizing: border-box;
            font-family: 'Kanit', sans-serif;
            font-size: 1.05rem;
        }

        * {
            font-family: 'Kanit', sans-serif;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar {
            transition: transform 0.3s ease;
        }



        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        /* Make table responsive on mobile */
        .table-container {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          width: 100%;
          margin-bottom: 15px;
        }

        .cdr-table {
          min-width: 600px; /* Wider than mobile screens to trigger scrolling */
          width: 100%;
        }

        /* Keep table headers sticky during horizontal scroll */
        .cdr-table thead tr {
          position: sticky;
          top: 0;
          background-color: #f0f7ff;
          z-index: 10;
        }

        /* Optional: Add subtle scrollbar styling for better UX */
        .table-container::-webkit-scrollbar {
          height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
          background: #f1f1f1;
        }

        .table-container::-webkit-scrollbar-thumb {
          background: #c1c1c1;
          border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
          background: #a8a8a8;
        }
    </style>
    <style>
        @view-transition {
            navigation: auto;
        }
    </style>
</head>

<body class="bg-gray-50"><!-- Login Screen -->
    <div id="loginScreen"
        class="min-h-screen flex items-center justify-center px-4 bg-gradient-to-br from-blue-50 to-blue-100">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-6"><img src="https://img5.pic.in.th/file/secure-sv1/IQRA-LOGO.png"
                    alt="Iqra Logo" class="h-24 mx-auto mb-4">
                <h1 class="text-3xl font-bold text-blue-600 mb-2">Smart CDR</h1>
                <p class="text-gray-600">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏¥‡∏Å‡πÄ‡∏£‡∏≤‡∏∞‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
            </div>
            <form id="loginForm" onsubmit="handleLoginSubmit(event)" class="space-y-4">
                <div><label for="loginEmail" class="block text-sm font-semibold text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label> <input
                        type="email" id="loginEmail" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
                </div>
                <div><label for="loginPassword" class="block text-sm font-semibold text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="loginPassword" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
                </div><button type="submit"
                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö </button>
            </form>
            </div>
        </div>
    </div><!-- Main App -->
    <div id="mainApp" class="hidden"><!-- Desktop Sidebar -->
        <div id="sidebar" class="hidden md:flex fixed left-0 top-0 h-full w-64 bg-blue-900 text-white z-40 flex-col">

            <div class="p-6 shrink-0">
                <img src="https://img5.pic.in.th/file/secure-sv1/IQRA-LOGO.png" alt="Logo" class="h-16 mx-auto mb-4">
                <h2 class="text-xl font-bold text-center mb-2">Smart CDR</h2>
                <p class="text-sm text-center text-blue-200" id="sidebarSchoolName">Iqra Muslim School</p>
            </div>

            <div class="px-4 shrink-0">
                <div class="mb-4 p-3 bg-blue-800 rounded-lg">
                    <p class="text-sm text-blue-200" id="sidebarWelcome">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</p>
                    <p class="font-semibold" id="currentUserName">User</p>
                    <p class="text-xs text-blue-300" id="currentUserRole">Role</p>
                </div>
            </div>

            <nav id="sidebarMenu" class="px-4 space-y-2 flex-1 overflow-y-auto min-h-0 pb-4">
            </nav>

            <div class="p-4 space-y-2 shrink-0 bg-blue-900 border-t border-blue-800">
                <button onclick="toggleLanguage()"
                    class="w-full bg-blue-800 hover:bg-blue-700 py-2 rounded-lg transition" id="sidebarLangToggle">
                    <span id="currentLang">TH</span> / <span id="otherLang">EN</span>
                </button>
                <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 py-2 rounded-lg transition"
                    id="logoutBtn">
                    üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </div>

        <!-- NEW: Backdrop Overlay -->
        <div id="actionSheetBackdrop"
            class="md:hidden fixed inset-0 bg-black/50 z-40 hidden opacity-0 transition-opacity duration-300"
            onclick="closeMobileMenu()">
        </div>

        <!-- NEW: Mobile Action Sheet (White Theme) -->
        <div id="mobileActionSheet"
            class="md:hidden fixed bottom-16 inset-x-0 bg-white text-gray-800 rounded-t-2xl shadow-[0_-8px_30px_-5px_rgba(0,0,0,0.2)] z-50 transform translate-y-[200%] transition-transform duration-300 ease-out max-h-[70vh] overflow-hidden">

            <!-- Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h3 id="actionSheetTitle" class="font-bold text-lg text-gray-900">Menu</h3>
                <button onclick="closeMobileMenu()"
                    class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>

            <!-- Scrollable Content -->
            <div id="actionSheetContent" class="p-4 overflow-y-auto max-h-[calc(70vh-60px)]">
                <!-- Dynamically injected by renderMobileMenu() -->
            </div>
        </div>

        <!-- NEW: Mobile Bottom Navigation -->
        <div id="bottomNav"
            class="md:hidden fixed bottom-0 inset-x-0 h-16 bg-blue-900 text-white z-40 flex justify-around items-center px-2 shadow-[0_-4px_10px_-3px_rgba(0,0,0,0.15)]">
            <!-- 5 items dynamically rendered by renderMobileMenu() -->
        </div>

        <!-- Main Content -->
        <div class="md:ml-64 mb-16 md:mb-0"><!-- Top Bar -->
            <div class="bg-white shadow-md p-4 flex justify-between items-center">
                <!-- Page Title (Left) -->
                <h1 class="text-2xl font-bold text-blue-600 truncate" id="pageTitle">Dashboard</h1>

                <!-- Right Side: User Profile - Desktop Only -->
                <div class="hidden md:flex items-center space-x-2">
                    <span class="text-sm text-gray-600" id="topBarUser">User</span>
                </div>

                <!-- Right Side: User Profile - Mobile (Clickable for Logout) -->
                <button onclick="confirmLogout()"
                    class="md:hidden flex items-center gap-3 px-3 py-2 rounded-lg bg-gray-50 hover:bg-red-50 border border-gray-200 hover:border-red-200 transition-all group">
                    <span class="text-xl">üë§</span>
                    <div class="flex flex-col text-left">
                        <span id="mobileUserName"
                            class="text-sm font-bold text-gray-700 group-hover:text-red-600 truncate max-w-[100px]">User</span>
                        <span id="mobileUserRole" class="text-[10px] text-gray-500 font-medium">Role</span>
                    </div>
                    <span class="text-lg">üö™</span>
                </button>
            </div><!-- Content Area -->
            <div id="contentArea" class="p-4 md:p-6"><!-- Dashboard will be loaded here -->
            </div>
        </div>
    </div>
    <script>
        let currentUser = null;
        let currentLanguage = 'th';
        // PROTECTED: Global cache for Rapid Entry performance
        let studentCache = {};

        // Authenticate on page load
        window.addEventListener('DOMContentLoaded', function () {
            authenticateOnLoad();
        });

        function authenticateOnLoad() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            const userEmail = sessionStorage.getItem('userEmail');
            const userRole = sessionStorage.getItem('userRole');

            if (isLoggedIn === 'true' && userEmail && userRole) {
                google.script.run
                    .withSuccessHandler(function (result) {
                        if (result.success) {
                            currentUser = result.user;
                            currentUser.role = userRole;
                            initializeAppUI();
                        } else {
                            sessionStorage.clear();
                            showLoginScreen();
                        }
                    })
                    .withFailureHandler(function (error) {
                        sessionStorage.clear();
                        showLoginScreen();
                    })
                    .getUserDetails(userEmail);
            } else {
                setTimeout(showLoginScreen, 50);
            }
        }

        // --- DUAL-GATEWAY AUTHENTICATION LOGIC ---

        // Global state for Kiosk Mode
        let kioskUser = null;
        let kioskStudent = null;

        function showLoginScreen() {
    // Ensure DOM is fully loaded before manipulating
    if (!document.getElementById('loginScreen')) {
        // If DOM not ready, wait and try again
        setTimeout(showLoginScreen, 100);
        return;
    }
    
    document.getElementById('mainApp').classList.add('hidden');
    const loginContainer = document.getElementById('loginScreen');
    loginContainer.classList.remove('hidden');

    // Clear any existing content first
    loginContainer.innerHTML = '';

    // Render the Choice Screen (Admin vs PIN)
    loginContainer.innerHTML = `
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md text-center relative">
            <img src="https://img5.pic.in.th/file/secure-sv1/IQRA-LOGO.png" alt="Logo" class="h-24 mx-auto mb-6">
            <h1 class="text-3xl font-bold text-blue-600 mb-2">Smart CDR</h1>
            <p class="text-gray-600 mb-8">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏¥‡∏Å‡πÄ‡∏£‡∏≤‡∏∞‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
            
            <div class="space-y-4">
                <button onclick="renderStandardLogin()" class="w-full group relative flex items-center justify-center py-4 px-6 border-2 border-blue-100 rounded-xl bg-white hover:bg-blue-50 transition-all duration-200">
                    <div class="text-left">
                        <h3 class="text-lg font-bold text-blue-900 group-hover:text-blue-700">Staff Dashboard</h3>
                        <p class="text-xs text-blue-400">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</p>
                    </div>
                    <span class="absolute right-6 text-2xl">üîê</span>
                </button>

                <button onclick="renderPINEntryUI()" class="w-full group relative flex items-center justify-center py-4 px-6 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl hover:shadow-lg hover:scale-[1.02] transition-all duration-200 text-white">
                    <div class="text-left">
                        <h3 class="text-lg font-bold">Rapid Entry Kiosk</h3>
                        <p class="text-xs text-blue-100">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢ PIN Code</p>
                    </div>
                    <span class="absolute right-6 text-2xl">‚ö°</span>
                </button>
            </div>
            
            <div class="mt-8 text-xs text-gray-400">System v2.2 ‚Ä¢ Iqra Muslim School</div>
        </div>
    `;
}

        function renderStandardLogin() {
    const loginContainer = document.getElementById('loginScreen');

    // Restore the original Email/Password Form
    loginContainer.innerHTML = `
<div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md relative">
    <button onclick="showLoginScreen()" class="absolute top-4 left-4 text-gray-400 hover:text-gray-600">‚Üê Back</button>
    <div class="text-center mb-6">
        <img src="https://img5.pic.in.th/file/secure-sv1/IQRA-LOGO.png" alt="Logo" class="h-24 mx-auto mb-6">
        <h1 class="text-3xl font-bold text-blue-600 mb-2">Smart CDR</h1>
        <p class="text-gray-600">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏¥‡∏Å‡πÄ‡∏£‡∏≤‡∏∞‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
    </div>
    <form id="loginForm" onsubmit="handleLoginSubmit(event)" class="space-y-4">
        <div>
            <label for="loginEmail" class="block text-sm font-semibold text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label> 
            <input type="email" id="loginEmail" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
        </div>
        <div>
            <label for="loginPassword" class="block text-sm font-semibold text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> 
            <input type="password" id="loginPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200"> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö </button>
    </form>
</div>
`;
}

        // Global Kiosk PIN State
        let currentKioskPin = '';

        function renderPINEntryUI() {
            const container = document.getElementById('loginScreen');
            currentKioskPin = ''; // Reset

            // Render Numpad UI
            container.innerHTML = `
    <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm mx-auto" id="kioskCard">
        <div id="pinStep">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">üîë Enter PIN</h2>
                <button onclick="showLoginScreen()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            
            <!-- Visual Display -->
            <div class="flex justify-center gap-4 mb-8">
                <div id="dot1" class="w-6 h-6 rounded-full border-2 border-blue-500 transition-all duration-200"></div>
                <div id="dot2" class="w-6 h-6 rounded-full border-2 border-blue-500 transition-all duration-200"></div>
                <div id="dot3" class="w-6 h-6 rounded-full border-2 border-blue-500 transition-all duration-200"></div>
            </div>

            <!-- Numpad Grid -->
            <div class="grid grid-cols-3 gap-4 text-xl font-bold mb-4">
                <button onclick="handleNumpadInput('1')" class="h-16 rounded-xl bg-gray-50 hover:bg-blue-50 active:bg-blue-100 transition shadow-sm border border-gray-100 flex items-center justify-center text-gray-700">1</button>
                <button onclick="handleNumpadInput('2')" class="h-16 rounded-xl bg-gray-50 hover:bg-blue-50 active:bg-blue-100 transition shadow-sm border border-gray-100 flex items-center justify-center text-gray-700">2</button>
                <button onclick="handleNumpadInput('3')" class="h-16 rounded-xl bg-gray-50 hover:bg-blue-50 active:bg-blue-100 transition shadow-sm border border-gray-100 flex items-center justify-center text-gray-700">3</button>
                
                <button onclick="handleNumpadInput('4')" class="h-16 rounded-xl bg-gray-50 hover:bg-blue-50 active:bg-blue-100 transition shadow-sm border border-gray-100 flex items-center justify-center text-gray-700">4</button>
                <button onclick="handleNumpadInput('5')" class="h-16 rounded-xl bg-gray-50 hover:bg-blue-50 active:bg-blue-100 transition shadow-sm border border-gray-100 flex items-center justify-center text-gray-700">5</button>
                <button onclick="handleNumpadInput('6')" class="h-16 rounded-xl bg-gray-50 hover:bg-blue-50 active:bg-blue-100 transition shadow-sm border border-gray-100 flex items-center justify-center text-gray-700">6</button>
                
                <button onclick="handleNumpadInput('7')" class="h-16 rounded-xl bg-gray-50 hover:bg-blue-50 active:bg-blue-100 transition shadow-sm border border-gray-100 flex items-center justify-center text-gray-700">7</button>
                <button onclick="handleNumpadInput('8')" class="h-16 rounded-xl bg-gray-50 hover:bg-blue-50 active:bg-blue-100 transition shadow-sm border border-gray-100 flex items-center justify-center text-gray-700">8</button>
                <button onclick="handleNumpadInput('9')" class="h-16 rounded-xl bg-gray-50 hover:bg-blue-50 active:bg-blue-100 transition shadow-sm border border-gray-100 flex items-center justify-center text-gray-700">9</button>
                
                <button onclick="handleNumpadClear()" class="h-16 rounded-xl bg-red-50 hover:bg-red-100 active:bg-red-200 transition text-red-600 flex items-center justify-center text-2xl">‚å´</button>
                <button onclick="handleNumpadInput('0')" class="h-16 rounded-xl bg-gray-50 hover:bg-blue-50 active:bg-blue-100 transition shadow-sm border border-gray-100 flex items-center justify-center text-gray-700">0</button>
                <button onclick="handlePinSubmit()" class="h-16 rounded-xl bg-blue-600 hover:bg-blue-700 active:bg-blue-800 transition shadow flex items-center justify-center text-white text-2xl">‚Üµ</button>
            </div>
            
            <p class="text-xs text-center text-gray-400 mt-4">Enter 3-Digit Officer PIN</p>
        </div>
    </div>
    `;
        }

        function handleNumpadInput(digit) {
            if (currentKioskPin.length < 3) {
                currentKioskPin += digit;
                updatePinDisplay();
            }
        }

        function handleNumpadClear() {
            currentKioskPin = currentKioskPin.slice(0, -1);
            updatePinDisplay();
        }

        function updatePinDisplay() {
            const dots = [document.getElementById('dot1'), document.getElementById('dot2'), document.getElementById('dot3')];
            dots.forEach((dot, index) => {
                if (index < currentKioskPin.length) {
                    dot.classList.add('bg-blue-500');
                } else {
                    dot.classList.remove('bg-blue-500');
                }
            });

            // Auto-submit if user wants? Or keep manual enter.
            // Manual enter is safer for touch screens to prevent accidental submits.
        }

        function handlePinSubmit() {
            if (currentKioskPin.length !== 3) {
                // Shake animation or visual feedback
                const dots = document.getElementById('dot1').parentElement;
                dots.classList.add('animate-bounce');
                setTimeout(() => dots.classList.remove('animate-bounce'), 500);
                return;
            }

            Swal.fire({ title: 'Verifying...', didOpen: () => Swal.showLoading() });

            google.script.run.withSuccessHandler((res) => {
                Swal.close();
                if (res.success) {
                    kioskUser = res.user; // Store session locally
                    renderKioskStudentInput(); // Move to Step 2
                } else {
                    Swal.fire({ icon: 'error', title: 'Invalid PIN', timer: 1500, showConfirmButton: false });
                    currentKioskPin = '';
                    updatePinDisplay();
                }
            }).authenticateByPIN(currentKioskPin);
        }

        // --- KIOSK STUDENT SELECTION LOGIC (Cascading) ---
        let kioskClassList = [];
        let kioskStudentList = []; // Array of {id, name, class}

        function renderKioskStudentInput() {
            const card = document.getElementById('kioskCard');
            // Reset state
            kioskStudentList = [];

            card.innerHTML = `
        <div class="flex justify-between items-start mb-6 border-b border-gray-100 pb-4">
            <div class="flex flex-col">
                <span class="text-[10px] uppercase tracking-wider text-gray-400 font-semibold">Current Officer</span>
                <span class="text-lg font-bold text-blue-700 flex items-center gap-1">
                    üë§ ${kioskUser.fullName}
                </span>
            </div>
            <button onclick="showLoginScreen()" class="text-xs text-red-500 hover:bg-red-50 px-3 py-1 rounded transition">Exit</button>
        </div>
        
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Identify Student</h2>
        
        <div class="space-y-6">
            <!-- Class Selection -->
            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">1. Select Class</label>
                <div class="relative">
                     <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">üè´</span>
                     <input list="kioskClasses" id="kioskClassInput" onchange="handleKioskClassChange()" 
                        class="w-full pl-12 pr-4 py-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none transition-all text-lg font-bold" 
                        placeholder="Search Class (e.g. 1A)">
                </div>
                <datalist id="kioskClasses"></datalist>
            </div>

            <!-- Student Selection -->
            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">2. Select Student</label>
                <div class="relative">
                     <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">üéì</span>
                     <input list="kioskStudents" id="kioskStudentInput" onchange="handleKioskStudentValidation()" disabled
                        class="w-full pl-12 pr-4 py-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none transition-all text-lg font-bold disabled:bg-gray-100 disabled:text-gray-400" 
                        placeholder="Select Class First...">
                </div>
                <datalist id="kioskStudents"></datalist>
            </div>

            <button onclick="handleKioskSelectionSubmit()" id="kioskNextBtn" disabled 
                class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-indigo-700 shadow-lg active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                Next ‚ûù
            </button>
        </div>
    `;

            // Load Classes Immediately
            loadKioskClasses();
        }

        function loadKioskClasses() {
            if (kioskClassList.length > 0) {
                populateDatalist('kioskClasses', kioskClassList);
                return;
            }

            // Fetch from Server
            google.script.run.withSuccessHandler((classes) => {
                kioskClassList = classes || [];
                populateDatalist('kioskClasses', kioskClassList);
            }).getAllClasses();
        }

        function handleKioskClassChange() {
            const classInput = document.getElementById('kioskClassInput');
            const studentInput = document.getElementById('kioskStudentInput');
            const studentListEl = document.getElementById('kioskStudents');
            const nextBtn = document.getElementById('kioskNextBtn');
            const selectedClass = classInput.value;

            // Reset Student Input
            studentInput.value = '';
            studentInput.disabled = true;
            studentInput.placeholder = 'Loading Students...';
            studentListEl.innerHTML = '';
            nextBtn.disabled = true;

            if (!selectedClass) return;

            // Fetch Students for Class
            google.script.run.withSuccessHandler((students) => {
                kioskStudentList = students || []; // format: {studentId, name, class, gender}

                // Populate Datalist: "Name (ID)"
                studentListEl.innerHTML = '';
                kioskStudentList.forEach(s => {
                    const option = document.createElement('option');
                    option.value = `${s.name} (${s.studentId})`;
                    studentListEl.appendChild(option);
                });

                studentInput.disabled = false;
                studentInput.placeholder = 'Search Student Name...';
                studentInput.focus();

            }).getStudentsByClass(selectedClass);
        }

        function handleKioskStudentValidation() {
            const inputVal = document.getElementById('kioskStudentInput').value;
            const nextBtn = document.getElementById('kioskNextBtn');

            // Allow submit only if input matches a valid student string
            // We verify by trying to extract ID
            const matches = inputVal.match(/\(([^)]+)\)$/);
            if (matches && matches[1]) {
                nextBtn.disabled = false;
            } else {
                nextBtn.disabled = true;
            }
        }

        function handleKioskSelectionSubmit() {
            const inputVal = document.getElementById('kioskStudentInput').value;

            // Extract ID from "Name (ID)"
            const matches = inputVal.match(/\(([^)]+)\)$/);

            if (!matches || !matches[1]) {
                Swal.fire('Error', 'Please select a valid student from the list.', 'warning');
                return;
            }

            const id = matches[1];

            // Re-use existing logic, but we already have the object in `kioskStudentList`
            // Let's find the full object to be safe
            const selectedObj = kioskStudentList.find(s => String(s.studentId) === String(id));

            if (selectedObj) {
                kioskStudent = { id: selectedObj.studentId, name: selectedObj.name, class: selectedObj.class };
                renderKioskActionChoice();
            } else {
                // Fallback fetch (shouldn't happen)
                handleKioskStudentSearchById(id);
            }
        }

        function handleKioskStudentSearchById(id) {
            Swal.fire({ title: 'Verifying...', didOpen: () => Swal.showLoading() });
            google.script.run.withSuccessHandler((res) => {
                Swal.close();
                if (res.success) {
                    kioskStudent = { id: id, name: res.name, class: res.class };
                    renderKioskActionChoice();
                } else {
                    Swal.fire('Not Found', 'Student ID not found', 'error');
                }
            }).getStudentNameByID(id);
        }

        function populateDatalist(id, items) {
            const list = document.getElementById(id);
            if (!list) return;
            list.innerHTML = '';
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                list.appendChild(option);
            });
        }

        function renderKioskActionChoice() {
            const card = document.getElementById('kioskCard');

            // Reset selection from previous entry
            selectedRapidReason = '';

            card.innerHTML = `
        <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
            <div class="text-sm font-bold text-blue-600 truncate max-w-[150px]">üë§ ${kioskUser.fullName}</div>
            <div class="text-xl font-mono font-bold text-gray-700 bg-gray-100 px-3 py-1 rounded-lg" id="kioskClock">--:--</div>
        </div>

        <div class="text-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">${kioskStudent.name}</h3>
            <span class="inline-block px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-sm font-mono mt-1 font-bold border border-blue-100">
                ${kioskStudent.class} ‚Ä¢ ${kioskStudent.id}
            </span>
        </div>

        <!-- MODE SELECTION: Lateness vs Incident -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <!-- Mode A: Activity Late -->
            <button onclick="renderKioskLatenessConfirm('Activity Late')" class="p-4 bg-yellow-50 border-2 border-yellow-200 rounded-2xl hover:bg-yellow-100 hover:border-yellow-400 transition-all text-center group active:scale-95">
                <div class="text-4xl mb-2 group-hover:scale-110 transition-transform">üü°</div>
                <div class="font-bold text-yellow-900 text-lg">Activity Late</div>
                <div class="text-xs text-yellow-700 opacity-75">‡∏™‡∏≤‡∏¢‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (7:40)</div>
            </button>
            
            <!-- Mode A: Real Late -->
            <button onclick="renderKioskLatenessConfirm('Real Late')" class="p-4 bg-red-50 border-2 border-red-200 rounded-2xl hover:bg-red-100 hover:border-red-400 transition-all text-center group active:scale-95">
                <div class="text-4xl mb-2 group-hover:scale-110 transition-transform">üî¥</div>
                <div class="font-bold text-red-900 text-lg">Real Late</div>
                <div class="text-xs text-red-700 opacity-75">‡∏™‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (8:00+)</div>
            </button>

            <!-- Mode B: Incident -->
            <button onclick="renderKioskIncidentForm()" class="p-4 bg-purple-50 border-2 border-purple-200 rounded-2xl hover:bg-purple-100 hover:border-purple-400 transition-all text-center group active:scale-95">
                <div class="text-4xl mb-2 group-hover:scale-110 transition-transform">üü£</div>
                <div class="font-bold text-purple-900 text-lg">Log Incident</div>
                <div class="text-xs text-purple-700 opacity-75">‡πÅ‡∏à‡πâ‡∏á‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</div>
            </button>
        </div>

        <button onclick="renderKioskStudentInput()" class="w-full mt-6 py-3 text-gray-400 hover:text-gray-600 transition-colors">‚Üê Back</button>
            `;

            // Initialize Clock immediately
            const updateClock = () => {
                const el = document.getElementById('kioskClock');
                if (el) el.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            };
            updateClock();
            const clockInterval = setInterval(() => {
                const el = document.getElementById('kioskClock');
                if (el) updateClock();
                else clearInterval(clockInterval);
            }, 1000);
        }

        function renderKioskLatenessConfirm(type) {
            const card = document.getElementById('kioskCard');

            card.innerHTML = `
        <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
            <div class="flex items-center gap-2">
                <button onclick="renderKioskActionChoice()" class="text-gray-500 hover:text-gray-700">‚Üê Back</button>
            </div>
            
            <div class="text-xl font-mono font-bold text-gray-700 bg-gray-100 px-3 py-1 rounded-lg" id="kioskConfirmClock">--:--</div>

            <div class="font-bold border px-2 py-1 rounded bg-white ${type === 'Real Late' ? 'text-red-600 border-red-200' : 'text-yellow-600 border-yellow-200'}">${type}</div>
        </div>

        <div class="text-center mb-6">
            <h3 class="text-xl font-bold text-gray-800">${kioskStudent.name}</h3>
            ${type === 'Real Late' ? '<p class="text-xs text-red-500 font-bold mt-1 bg-red-50 inline-block px-2 py-1 rounded">‚ö†Ô∏è Deducts Bonus + Auto-CDR Level 1</p>' : ''}
        </div>

        <div class="mb-6 text-left">
            <label class="block text-gray-700 font-bold mb-2">Reason / ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</label>
            <div class="flex flex-wrap gap-2" id="reasonChipsContainer">
                    <button type="button" onclick="selectReasonChip('‡∏£‡∏ñ‡∏ï‡∏¥‡∏î')" id="chip_traffic" class="reason-chip px-4 py-2 rounded-full border border-gray-300 bg-gray-50 text-gray-700 hover:bg-gray-200 transition-colors">üöó ‡∏£‡∏ñ‡∏ï‡∏¥‡∏î</button>
                    <button type="button" onclick="selectReasonChip('‡∏ï‡∏∑‡πà‡∏ô‡∏™‡∏≤‡∏¢')" id="chip_overslept" class="reason-chip px-4 py-2 rounded-full border border-gray-300 bg-gray-50 text-gray-700 hover:bg-gray-200 transition-colors">üò¥ ‡∏ï‡∏∑‡πà‡∏ô‡∏™‡∏≤‡∏¢</button>
                    <button type="button" onclick="selectReasonChip('‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏∞')" id="chip_errand" class="reason-chip px-4 py-2 rounded-full border border-gray-300 bg-gray-50 text-gray-700 hover:bg-gray-200 transition-colors">üìù ‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏∞</button>
                    <button type="button" onclick="selectReasonChip('‡∏≠‡∏∑‡πà‡∏ô ‡πÜ')" id="chip_other" class="reason-chip px-4 py-2 rounded-full border border-gray-300 bg-gray-50 text-gray-700 hover:bg-gray-200 transition-colors">‚úèÔ∏è ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</button>
            </div>
            
            <div id="otherReasonContainer" class="hidden mt-3 transition-all duration-300 origin-top">
                <input type="text" id="manualReasonInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏...">
            </div>
        </div>

        <button onclick="submitKioskRecord('${type}')" class="w-full py-4 text-white font-bold text-xl rounded-xl shadow-lg active:scale-95 transition-all ${type === 'Real Late' ? 'bg-red-600 hover:bg-red-700' : 'bg-yellow-500 hover:bg-yellow-600'}">
            CONFIRM LOG
        </button>
            `;

            // Initialize Clock within this view
            const updateConfirmClock = () => {
                const el = document.getElementById('kioskConfirmClock');
                if (el) el.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            };
            updateConfirmClock();
            const confirmClockInterval = setInterval(() => {
                const el = document.getElementById('kioskConfirmClock');
                if (el) updateConfirmClock();
                else clearInterval(confirmClockInterval);
            }, 1000);
        }

        // Global cache for categories
        let cachedCategories = null;

        function renderKioskIncidentForm() {
            // Check if we have categories, if not fetch them
            if (!cachedCategories) {
                showLoading('Loading Categories...');
                google.script.run
                    .withSuccessHandler(function (cats) {
                        hideLoading();
                        cachedCategories = cats || {};
                        renderKioskIncidentFormUI(); // Recursively call to render
                    })
                    .withFailureHandler(function (e) {
                        hideLoading();
                        showToast('Error', 'Failed to load categories', 'error');
                    })
                    .getOffenseCategories();
                return;
            }
            renderKioskIncidentFormUI();
        }

        function renderKioskIncidentFormUI() {
            const student = kioskStudent; // Correct variable name for Kiosk mode
            if (!student) return;

            const card = document.getElementById('kioskCard');

            const formHTML = `
        <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
            <button onclick="renderKioskActionChoice()" class="text-gray-500 hover:text-gray-700">‚Üê Back</button>
            <div class="font-bold text-purple-700">Log Incident</div>
        </div>

        <div class="text-center mb-4">
            <h3 class="text-lg font-bold text-gray-800">${student.name}</h3>
             <span class="inline-block px-3 py-1 bg-purple-50 text-purple-700 rounded-full text-xs font-mono mt-1 font-bold border border-purple-100">
                ${student.class} ‚Ä¢ ${student.id}
            </span>
        </div>

        <div class="space-y-4 text-left">
            <!-- Level Selection -->
            <div>
                <label class="block text-gray-700 font-bold mb-1 text-sm">Level</label>
                <div class="flex gap-2">
                    <button onclick="selectIncidentLevel('Level 1')" id="btnLevel1" class="flex-1 py-3 px-4 rounded-lg border-2 border-yellow-400 hover:bg-yellow-50 flex items-center justify-center transition-all level-btn">
                        <span class="text-xl mr-2">‚ö†Ô∏è</span>
                        <div class="text-left">
                            <div class="font-bold text-gray-800">Level 1</div>
                            <div class="text-xs text-gray-500">${currentLanguage === 'th' ? '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' : 'Minor Offense'}</div>
                        </div>
                    </button>
                    
                    <button onclick="selectIncidentLevel('Level 2')" id="btnLevel2" class="flex-1 py-3 px-4 rounded-lg border-2 border-red-500 hover:bg-red-50 flex items-center justify-center transition-all level-btn">
                        <span class="text-xl mr-2">üö´</span>
                        <div class="text-left">
                            <div class="font-bold text-gray-800">Level 2</div>
                            <div class="text-xs text-gray-500">${currentLanguage === 'th' ? '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á' : 'Major Offense'}</div>
                        </div>
                    </button>
                </div>
                <input type="hidden" id="incidentLevel">
            </div>

            <!-- Category Selection (Hidden initially) -->
            <div id="categorySection" class="hidden">
                <label class="block text-gray-700 font-bold mb-1 text-sm">Category</label>
                <select id="incidentCategory" class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="">${currentLanguage === 'th' ? '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --' : '-- Select Category --'}</option>
                </select>
            </div>

            <!-- Description -->
            <div>
                <label class="block text-gray-700 font-bold mb-1 text-sm">Description (Optional)</label>
                <textarea id="incidentDesc" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" rows="2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
            </div>
        </div>

        <button onclick="submitKioskIncident()" class="w-full mt-4 py-4 bg-purple-600 text-white font-bold text-xl rounded-xl shadow-lg hover:bg-purple-700 active:scale-95 transition-all">
            SUBMIT INCIDENT
        </button>
    `;

            card.innerHTML = formHTML;
        }

        function selectIncidentLevel(level) {
            // UI Update
            const btn1 = document.getElementById('btnLevel1');
            const btn2 = document.getElementById('btnLevel2');

            // Reset styles
            btn1.className = 'flex-1 py-3 px-4 rounded-lg border-2 border-gray-200 bg-white text-gray-500 font-semibold flex items-center justify-center transition-all level-btn opacity-60 hover:opacity-100';
            btn2.className = 'flex-1 py-3 px-4 rounded-lg border-2 border-gray-200 bg-white text-gray-500 font-semibold flex items-center justify-center transition-all level-btn opacity-60 hover:opacity-100';

            if (level === 'Level 1') {
                btn1.className = 'flex-1 py-3 px-4 rounded-lg border-2 border-yellow-400 bg-yellow-50 text-gray-800 font-bold flex items-center justify-center transition-all level-btn ring-2 ring-yellow-200';
            } else {
                btn2.className = 'flex-1 py-3 px-4 rounded-lg border-2 border-red-500 bg-red-50 text-gray-800 font-bold flex items-center justify-center transition-all level-btn ring-2 ring-red-200';
            }

            document.getElementById('incidentLevel').value = level;

            // Populate Categories
            const categorySelect = document.getElementById('incidentCategory');
            const categorySection = document.getElementById('categorySection');

            // Clear existing
            categorySelect.innerHTML = `<option value="">${currentLanguage === 'th' ? '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --' : '-- Select Category --'}</option>`;

            // Get from cache
            const cats = cachedCategories[level] || [];

            cats.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name; // Keep saving the Name for now as per `saveCDRRecord` expectation (it wants a string)
                option.text = cat.name;
                categorySelect.appendChild(option);
            });

            // Show section
            categorySection.classList.remove('hidden');
        }

        function submitKioskRecord(type) {
            // 1. Validate Reason
            let finalReason = selectedRapidReason;

            // Check if 'Others' is selected and manual input is empty
            if (selectedRapidReason === '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ') {
                const manualInput = document.getElementById('manualReasonInput');
                if (manualInput && manualInput.value.trim() !== '') {
                    finalReason = manualInput.value.trim();
                } else {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Missing Reason',
                        text: 'Please specify the reason.',
                        timer: 2000
                    });
                    if (manualInput) manualInput.focus();
                    return;
                }
            }

            // Check if no reason is selected at all
            if (!finalReason) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Reason Selected',
                    text: 'Please select a reason before saving.',
                    timer: 2000
                });
                return;
            }

            // 2. Prepare Record
            const record = {
                studentId: kioskStudent.id,
                studentName: kioskStudent.name,
                class: kioskStudent.class,
                recordType: type,
                reason: finalReason,
                recordedBy: kioskUser.fullName,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }),
                isPinAuth: true
            };

            // 3. Save
            Swal.fire({ title: 'Saving...', didOpen: () => Swal.showLoading() });

            google.script.run.withSuccessHandler((res) => {
            Swal.close();
            // Handle duplicate error
            if (res.duplicate) {
            Swal.fire({
            icon: 'warning',
            title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡πâ‡∏≥',
            text: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß',
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
            confirmButtonColor: '#3B82F6'
            });
            return;
            }

            let msg = `${kioskStudent.name} - ${finalReason}`;
            let icon = 'success';
            let title = 'Recorded!';
            let timer = 1500;
            let showConfirm = false;
            // CHECK ACTION MESSAGE (Monthly Logic)
            if (res.action) {
            msg += `
            ${res.action}`;
            timer = 5000;
            showConfirm = true;
            if (res.action.includes('CRITICAL') || res.action.includes('Warning')) icon = 'warning';
            }
            Swal.fire({
            icon: icon,
            title: title,
            text: msg,
            timer: timer,
            showConfirmButton: showConfirm,
            didClose: () => {
            renderKioskStudentInput(); // Loop back for next student
            }
            });
            }).saveLatenessRecord(record);
        }

        function submitKioskIncident() {
            const level = document.getElementById('incidentLevel').value;
            const category = document.getElementById('incidentCategory').value;
            const desc = document.getElementById('incidentDesc').value;

            const record = {
                date: new Date().toISOString().split('T')[0],
                studentId: kioskStudent.id,
                studentName: kioskStudent.name,
                class: kioskStudent.class,
                level: level,
                category: category,
                description: desc || 'Reported via Kiosk',
                recordedBy: kioskUser.fullName,
                status: 'Recorded',
                notes: 'Kiosk Entry'
            };

            Swal.fire({ title: 'Processing Rules...', didOpen: () => Swal.showLoading() });

            google.script.run.withSuccessHandler((res) => {
                Swal.close();
                if (res.success) {
                    // SHOW RED ALERT POPUP
                    Swal.fire({
                        icon: 'warning',
                        title: 'Incident Recorded',
                        html: `
                            <div class="text-left bg-red-50 p-4 rounded-lg border border-red-200">
                                <p><strong>Strike Count:</strong> ${res.offenseCount}</p>
                                <p class="text-red-700 font-bold mt-2">Punishment Required:</p>
                                <p class="text-xl text-red-800">${res.punishment}</p>
                            </div>
                        `,
                        confirmButtonText: 'ACKNOWLEDGE',
                        confirmButtonColor: '#d33'
                    }).then(() => {
                        renderKioskStudentInput(); // Reset
                    });
                } else {
                    Swal.fire('Error', res.message, 'error');
                }
            }).saveCDRRecord(record);
        }


        function initializeAppUI() {
        // 1. Switch Screens
        document.getElementById('loginScreen').classList.add('hidden');
        const mainApp = document.getElementById('mainApp');
        mainApp.classList.remove('hidden');

        // 2. Update User Profile Info
        document.getElementById('currentUserName').textContent = currentUser.fullName;
        document.getElementById('currentUserRole').textContent = currentUser.role;
        document.getElementById('topBarUser').textContent = currentUser.fullName;
        document.getElementById('mobileUserName').textContent = currentUser.fullName;
        document.getElementById('mobileUserRole').textContent = currentUser.role;

        // 3. Render Navigation
        renderMenu();

        // 4. MOBILE RENDERING FIX
        // Mobile browsers need a moment to process the removal of '.hidden' 
        // before they can correctly render the dashboard content.
        if (window.innerWidth <= 768) {
            setTimeout(() => {
                // Force a "Reflow" (tells browser to recalculate layout immediately)
                void mainApp.offsetHeight; 
                
                // Now load the page. We use loadPage() instead of loadDashboard()
                // to ensure the title and window.currentPage state are set correctly.
                loadPage('dashboard');
            }, 100); // 100ms delay is usually enough to fix the blank screen
        } else {
            // Desktop can handle immediate loading
            loadPage('dashboard');
        }
    }

        function handleLoginSubmit(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...',
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            google.script.run
                .withSuccessHandler(function (result) {
                    Swal.close();
                    if (result.success) {
                        const roles = result.roles;
                        if (roles.includes(',')) {
                            const roleOptions = roles.split(',').map(role => role.trim());
                            const radioOptions = {};
                            roleOptions.forEach(role => { radioOptions[role] = role; });

                            Swal.fire({
                                title: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó',
                                text: '‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
                                input: 'radio',
                                inputOptions: radioOptions,
                                inputValidator: (value) => { if (!value) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó'; },
                                confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
                                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                                showCancelButton: true
                            }).then((roleResult) => {
                                if (roleResult.isConfirmed) { completeLogin(email, roleResult.value); }
                            });
                        } else {
                            completeLogin(email, roles);
                        }
                    } else {
                        Swal.fire({ icon: 'error', title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: result.message, confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á' });
                    }
                })
                .withFailureHandler(function (error) {
                    Swal.close();
                    Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: error, confirmButtonText: '‡∏õ‡∏¥‡∏î' });
                })
                .authenticateUser(email, password);
        }

        function completeLogin(email, selectedRole) {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
            google.script.run
                .withSuccessHandler(function (result) {
                    Swal.close();
                    if (result.success) {
                        currentUser = result.user;
                        currentUser.role = selectedRole;
                        sessionStorage.setItem('isLoggedIn', 'true');
                        sessionStorage.setItem('userEmail', email);
                        sessionStorage.setItem('userRole', selectedRole);
                        initializeAppUI();
                        Swal.fire({ icon: 'success', title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${currentUser.fullName}`, timer: 2000, showConfirmButton: false });
                    } else {
                        Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: result.message, confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á' });
                    }
                })
                .withFailureHandler(function (error) {
                    Swal.close();
                    Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: error, confirmButtonText: '‡∏õ‡∏¥‡∏î' });
                })
                .getUserDetails(email);
        }

        function logout() {
            Swal.fire({
                icon: 'question',
                title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                showCancelButton: true,
                confirmButtonText: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#dc2626'
            }).then((result) => {
                if (result.isConfirmed) {
                    sessionStorage.clear();
                    currentUser = null;
                    document.getElementById('mainApp').classList.add('hidden');
                    document.getElementById('loginScreen').classList.remove('hidden');
                }
            });
        }

        const translations = {
            th: {
                sidebarSchoolName: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏¥‡∏Å‡πÄ‡∏£‡∏≤‡∏∞‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤',
                sidebarWelcome: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö',
                logoutBtn: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
                dashboard: '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î',
                logCDR: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å CDR',
                cdrManagement: '‡πÅ‡∏ú‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ CDR',
                myClassCDR: 'CDR ‡∏´‡πâ‡∏≠‡∏á‡∏â‡∏±‡∏ô',
                latenessRecord: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢',
                manageLateness: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢',
                attendance: '‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠',
                tidiness: '‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                parentMeetings: '‡∏ô‡∏±‡∏î‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á',
                reports: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
                userManagement: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ',
                settings: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤',
                loading: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
                totalCDR: 'CDR ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                level1Cases: '‡πÄ‡∏Ñ‡∏™ Level 1',
                level2Cases: '‡πÄ‡∏Ñ‡∏™ Level 2',
                latenessToday: '‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
                pendingMeetings: '‡∏£‡∏≠‡∏ô‡∏±‡∏î‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á',
                rapidEntry: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πà‡∏ß‡∏ô (Rapid Entry)',
                search: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤'
            },
            en: {
                sidebarSchoolName: 'Iqra Muslim School',
                sidebarWelcome: 'Welcome',
                logoutBtn: 'Logout',
                dashboard: 'Dashboard',
                logCDR: 'Log CDR',
                cdrManagement: 'CDR Admin Panel',
                myClassCDR: 'My Class CDR',
                latenessRecord: 'Lateness Record',
                manageLateness: 'Manage Lateness',
                attendance: 'Attendance',
                tidiness: 'Tidiness Check',
                parentMeetings: 'Parent Meetings',
                reports: 'Reports',
                userManagement: 'User Management',
                settings: 'Settings',
                loading: 'Loading...',
                totalCDR: 'Total CDR',
                level1Cases: 'Level 1 Cases',
                level2Cases: 'Level 2 Cases',
                latenessToday: 'Late Today',
                pendingMeetings: 'Pending Meetings',
                rapidEntry: 'Rapid Entry',
                search: 'Search'
            }
        };

        function showLoading(message) {
            Swal.fire({
                title: message || (currentLanguage === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...' : 'Loading...'),
                text: currentLanguage === 'th' ? '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà' : 'Please wait',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });
        }

        function hideLoading() { Swal.close(); }
        function toggleLanguage() { currentLanguage = currentLanguage === 'th' ? 'en' : 'th'; updateLanguage(); }

        function updateLanguage() {
            const t = translations[currentLanguage];
            if (currentUser) {
                document.getElementById('sidebarSchoolName').textContent = t.sidebarSchoolName;
                document.getElementById('sidebarWelcome').textContent = t.sidebarWelcome;
                document.getElementById('logoutBtn').textContent = currentLanguage === 'th' ? 'üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö' : 'üö™ Logout';
                document.getElementById('currentLang').textContent = currentLanguage.toUpperCase();
                document.getElementById('otherLang').textContent = currentLanguage === 'th' ? 'EN' : 'TH';
                renderMenu();
                loadDashboard();
            }
        }

        let misbehaviorCategories = null;
        google.script.run.withSuccessHandler(function (data) { misbehaviorCategories = data; }).getMisbehaviorList();

        function renderMenu() {
            const sidebarMenu = document.getElementById('sidebarMenu');
            const menuItems = getMenuItems();

            // --- Desktop Sidebar (Unchanged) ---
            sidebarMenu.innerHTML = '';
            const t = translations[currentLanguage];
            menuItems.forEach(item => {
                const button = document.createElement('button');
                button.className = 'w-full text-left px-4 py-3 rounded-lg hover:bg-blue-800 transition flex items-center space-x-3 shrink-0';
                button.innerHTML = `<span class="text-xl">${item.icon}</span><span>${t[item.key] || item.key}</span>`;
                button.onclick = () => loadPage(item.page);
                sidebarMenu.appendChild(button);
            });

            // --- Mobile Bottom Nav ---
            renderMobileMenu();
        }

        // --- NEW: Mobile Navigation Logic ---
        function renderMobileMenu() {
            // md:hidden on #bottomNav handles desktop hiding via CSS
            const bottomNav = document.getElementById('bottomNav');
            const t = translations[currentLanguage];
            const isAdmin = ['Superadmin', 'VP', 'DisciplineDept'].includes(currentUser.role);
            const menuItems = getMenuItems();

            bottomNav.innerHTML = '';

            // Get first 4 menu items for slots 1, 2, 4, 5
            const primaryItems = menuItems.slice(0, 4);

            if (isAdmin) {
                // Admin Layout: [Item1] [Item2] [‚öôÔ∏è Admin] [Item3] [Item4]
                if (primaryItems[0]) renderBottomNavItem(bottomNav, primaryItems[0]);
                if (primaryItems[1]) renderBottomNavItem(bottomNav, primaryItems[1]);

                // Center: Admin Tools Button
                const adminBtn = document.createElement('button');
                adminBtn.className = 'flex flex-col items-center justify-center w-full relative';
                adminBtn.onclick = openMobileMenu;
                adminBtn.innerHTML = `
                    <div class="bg-blue-600 rounded-full p-3 shadow-lg -mt-4 border-4 border-blue-900">
                        <span class="text-white text-xl">‚öôÔ∏è</span>
                    </div>
                    <span class="text-[10px] font-bold text-blue-300 mt-1">Admin</span>
                `;
                bottomNav.appendChild(adminBtn);

                if (primaryItems[2]) renderBottomNavItem(bottomNav, primaryItems[2]);
                if (primaryItems[3]) renderBottomNavItem(bottomNav, primaryItems[3]);

            } else {
                // User Layout: [Item1] [Item2] [Item3] [Item4] [‚ò∞ More]
                primaryItems.forEach(item => renderBottomNavItem(bottomNav, item));

                // Slot 5: More Button
                const moreBtn = document.createElement('button');
                moreBtn.className = 'flex flex-col items-center justify-center w-full text-blue-200 hover:text-white transition';
                moreBtn.onclick = openMobileMenu;
                moreBtn.innerHTML = `
                    <span class="text-2xl mb-0.5">‚ò∞</span>
                    <span class="text-[10px]">${t['more'] || 'More'}</span>
                `;
                bottomNav.appendChild(moreBtn);
            }
        }

        function renderBottomNavItem(container, item) {
            const t = translations[currentLanguage];
            const isActive = window.currentPage === item.page;
            const btn = document.createElement('button');
            btn.className = `flex flex-col items-center justify-center w-full transition ${isActive ? 'text-white font-bold' : 'text-blue-200 hover:text-white'}`;
            btn.onclick = () => loadPage(item.page);
            btn.innerHTML = `
                <span class="text-xl mb-0.5">${item.icon}</span>
                <span class="text-[10px] truncate max-w-[56px]">${t[item.key] || item.key}</span>
            `;
            container.appendChild(btn);
        }

        let mobileMenuOpen = false;

        function openMobileMenu() {
            const sheet = document.getElementById('mobileActionSheet');
            const backdrop = document.getElementById('actionSheetBackdrop');
            if (!sheet || mobileMenuOpen) return;

            mobileMenuOpen = true;

            // Render content based on role
            renderMobileMenuContent();

            // Show backdrop
            backdrop.classList.remove('hidden');
            requestAnimationFrame(() => backdrop.classList.add('opacity-100'));

            // Slide up sheet
            sheet.classList.remove('translate-y-[200%]');
        }

        function closeMobileMenu() {
            const sheet = document.getElementById('mobileActionSheet');
            const backdrop = document.getElementById('actionSheetBackdrop');
            if (!sheet || !mobileMenuOpen) return;

            mobileMenuOpen = false;

            // Hide backdrop
            backdrop.classList.remove('opacity-100');
            setTimeout(() => backdrop.classList.add('hidden'), 300);

            // Slide down sheet
            sheet.classList.add('translate-y-[200%]');
        }

        function renderMobileMenuContent() {
            const isAdmin = ['Superadmin', 'VP', 'DisciplineDept'].includes(currentUser.role);
            const container = document.getElementById('actionSheetContent');
            const title = document.getElementById('actionSheetTitle');
            const t = translations[currentLanguage];

            container.innerHTML = '';

            if (isAdmin) {
                // ADMIN: Grid Layout
                title.textContent = t['adminTools'] || 'Admin Tools';

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-3 gap-3';

                getAdminSheetItems().forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'flex flex-col items-center justify-center p-4 bg-gray-50 hover:bg-blue-50 rounded-xl border border-gray-200 hover:border-blue-300 transition-colors';
                    btn.innerHTML = `
                        <span class="text-3xl mb-2">${item.icon}</span>
                        <span class="text-xs text-center font-medium text-gray-700 leading-tight">${item.label}</span>
                    `;
                    btn.onclick = () => { closeMobileMenu(); loadPage(item.page); };
                    grid.appendChild(btn);
                });

                container.appendChild(grid);

            } else {
                // USER: List Layout
                title.textContent = t['menu'] || 'Menu';

                const list = document.createElement('div');
                list.className = 'flex flex-col space-y-2';

                // Extra menu items (beyond first 4)
                const extras = getMenuItems().slice(4);
                extras.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'flex items-center gap-4 p-3 bg-gray-50 hover:bg-blue-50 rounded-lg border border-gray-200 hover:border-blue-300 transition-colors w-full text-left';
                    btn.innerHTML = `
                        <span class="text-xl w-8 text-center">${item.icon}</span>
                        <span class="font-medium text-gray-800">${t[item.key] || item.key}</span>
                    `;
                    btn.onclick = () => { closeMobileMenu(); loadPage(item.page); };
                    list.appendChild(btn);
                });

                // Divider
                const divider = document.createElement('div');
                divider.className = 'h-px bg-gray-200 my-2';
                list.appendChild(divider);

                // Language Toggle
                const langBtn = document.createElement('button');
                langBtn.className = 'flex items-center gap-4 p-3 bg-gray-50 hover:bg-blue-50 rounded-lg border border-gray-200 transition-colors w-full text-left';
                langBtn.innerHTML = `
                    <span class="text-xl w-8 text-center">üåê</span>
                    <span class="font-medium text-gray-800">${currentLanguage === 'th' ? 'Switch to English' : '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢'}</span>
                `;
                langBtn.onclick = () => { closeMobileMenu(); toggleLanguage(); };
                list.appendChild(langBtn);

                // Logout
                const logoutBtn = document.createElement('button');
                logoutBtn.className = 'flex items-center gap-4 p-3 bg-red-50 hover:bg-red-100 rounded-lg border border-red-200 transition-colors w-full text-left';
                logoutBtn.innerHTML = `
                    <span class="text-xl w-8 text-center">üö™</span>
                    <span class="font-medium text-red-600">${t['logout'] || 'Logout'}</span>
                `;
                logoutBtn.onclick = () => { closeMobileMenu(); logout(); };
                list.appendChild(logoutBtn);

                container.appendChild(list);
            }
        }

        function confirmLogout() {
            Swal.fire({
                title: currentLanguage === 'th' ? '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?' : 'Logout?',
                text: currentLanguage === 'th' ? '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà' : 'Are you sure you want to logout?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#DC2626',
                cancelButtonColor: '#6B7280',
                confirmButtonText: currentLanguage === 'th' ? '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö' : 'Logout',
                cancelButtonText: currentLanguage === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    logout();
                }
            });
        }

        function getAdminSheetItems() {
            const t = translations[currentLanguage];
            const role = currentUser.role;
            const items = [];

            // Core Admin Features
            items.push({ page: 'cdr', icon: 'üìù', label: t['cdrManagement'] || 'CDR Mgmt' });
            items.push({ page: 'pendingApprovals', icon: '‚úÖ', label: t['pendingApprovals'] || 'Approvals' });
            items.push({ page: 'reports', icon: 'üìä', label: t['reports'] || 'Reports' });
            items.push({ page: 'behaviorScores', icon: 'üìà', label: t['behaviorScores'] || 'Analysis' });

            if (role === 'Superadmin') {
                items.push({ page: 'userManagement', icon: 'üë•', label: t['userManagement'] || 'Users' });
                items.push({ page: 'systemSettings', icon: '‚öôÔ∏è', label: t['systemSettings'] || 'Settings' });
            }
            return items;
        }



        function getMenuItems() {
            const role = currentUser.role;
            const items = [];

            // --- RAPID ENTRY (On-Duty Teacher, Office Staff, Admins) ---
            if (['OnDutyTeacher', 'OfficeStaff', 'Superadmin', 'VP', 'DisciplineDept'].includes(role)) {
                items.push({ key: 'rapidEntry', icon: '‚ö°', page: 'rapidEntry' });
            }

            items.push({ key: 'dashboard', icon: 'üìä', page: 'dashboard' });


            // REMOVED: logCDR (HRTs/Teachers must use Kiosk Mode or Modal)


            if (['Superadmin', 'VP', 'DisciplineDept'].includes(role)) {
                items.push({ key: 'cdrManagement', icon: 'üìù', page: 'cdr' });
                items.push({ key: 'pendingApprovals', icon: '‚úÖ', page: 'pendingApprovals' });
            }

            if (['HRT'].includes(role)) {
                items.push({ key: 'myClassCDR', icon: 'üìã', page: 'myClassCDR' });
            }

            if (['HRT', 'OnDutyTeacher', 'OfficeStaff'].includes(role)) {
                items.push({ key: 'latenessRecord', icon: '‚è∞', page: 'lateness' });
            }

            if (['HRT'].includes(role)) {
                items.push({ key: 'manageLateness', icon: '‚è±Ô∏è', page: 'manageLateness' });
                items.push({ key: 'attendance', icon: '‚úÖ', page: 'attendance' });
                items.push({ key: 'tidiness', icon: 'üëî', page: 'tidiness' });
            }

            if (['OfficeStaff'].includes(role)) {
                items.push({ key: 'parentMeetings', icon: 'üë®‚Äçüë©‚Äçüëß', page: 'parentMeetings' });
            }

            if (['Superadmin', 'VP', 'DisciplineDept', 'HRT'].includes(role)) {
                items.push({ key: 'reports', icon: 'üìà', page: 'reports' });
                items.push({ key: 'behaviorScores', icon: 'üíØ', page: 'behaviorScores' });
            }

            if (['Superadmin'].includes(role)) {
                items.push({ key: 'userManagement', icon: 'üë•', page: 'userManagement' });
                items.push({ key: 'settings', icon: '‚öôÔ∏è', page: 'systemSettings' });
            }

            return items;
        }







        window.addEventListener('resize', function () {
            if (window.innerWidth >= 768 && mobileMenuOpen) {
                closeMobileMenu();
            }
        });

        function loadPage(page) {
            window.currentPage = page; // Track current page for Refresh Logic
            const t = translations[currentLanguage];
            if (page === 'rapidEntry') {
                document.getElementById('pageTitle').textContent = currentLanguage === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πà‡∏ß‡∏ô (Rapid Entry)' : 'Rapid Entry';
            } else {
                document.getElementById('pageTitle').textContent = t[page] || t.dashboard;
            }

            switch (page) {
                case 'dashboard': loadDashboard(); break;
                case 'rapidEntry': renderRapidEntryPage(); break;
                case 'logCDR': showAddCDRForm(); break;
                case 'cdr': loadCDRPage(); break;
                case 'myClassCDR': loadMyClassCDR(); break;
                case 'lateness': loadLatenessPage(); break;
                case 'behaviorScores': loadBehaviorScoreboard(); break;
                case 'analysis': loadAnalysisPage(); break; // Assuming loadAnalysisPage() exists or will be created
                case 'attendance': loadAttendancePage(); break;
                case 'tidiness': loadTidinessPage(); break;
                case 'parentMeetings': loadParentMeetingsPage(); break;
                case 'pendingApprovals': loadPendingApprovalsPage(); break;
                case 'reports': loadReportsPage(); break;
                case 'behaviorScores': loadBehaviorScoreboard(); break;
                case 'manageLateness': loadManageLatenessPage(); break;
                case 'userManagement': loadUserManagementPage(); break;
                case 'systemSettings': loadSystemSettingsPage(); break;
                default: loadDashboard();
            }

            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.remove('active');
            }
        }

        function loadDashboard() {
            const t = translations[currentLanguage];
            const role = currentUser.role;

            // --- 1. HRT Verification Queue Logic ---
            if (role === 'HRT') {
                google.script.run.withSuccessHandler((records) => {
                    if (records.length > 0) {
                        renderVerificationQueue(records);
                    }
                }).getUnverifiedRecords(currentUser.assignedClasses);
            }

            // --- 2. Special Landing for On-Duty Teacher ---
            if (role === 'OnDutyTeacher') {
                renderRapidEntryPage();
                return;
            }

            // --- 2.1 Special Landing for Kiosk Mode ---
            if (role === 'Kiosk') {
                renderKioskActionChoice();
                return;
            }

            // --- 3. Office Staff Dashboard ---
            if (role === 'OfficeStaff') {
                loadOfficeDashboard();
                return;
            }

            // --- 4. Superadmin / VP / Discipline Dashboard (Global Stats) ---
            if (['Superadmin', 'VP', 'DisciplineDept'].includes(role)) {
                loadSuperAdminDashboard();
                return;
            }

            // --- 5. Standard Dashboard (HRT/Teacher) ---
            if (['HRT', 'Teacher'].includes(role)) {
                loadTeacherDashboard();
                return;
            }

            if (role === 'Student') { loadStudentDashboard(); }
        }

        // --- SUPERADMIN / VP DASHBOARD ---
        // --- SUPERADMIN / VP DASHBOARD ---
        function loadSuperAdminDashboard() {
            showLoading();
            // Default to "This Month"
            const date = new Date();
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
            const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);

            // Ensure dates are string format YYYY-MM-DD
            const offset = date.getTimezoneOffset() * 60000;
            const startStr = new Date(firstDay.getTime() - offset).toISOString().split('T')[0];
            const endStr = new Date(lastDay.getTime() - offset).toISOString().split('T')[0];

            // PARALLEL FETCH: Get Stats, Parent Meeting Approvals, AND Bonus Deductions (Real Late)
            Promise.all([
                new Promise((res, rej) => google.script.run.withSuccessHandler(res).withFailureHandler(rej).getSystemReportData(startStr, endStr, currentUser.role, currentUser.assignedClasses)),
                new Promise((res, rej) => google.script.run.withSuccessHandler(res).withFailureHandler(rej).getPendingApprovals(currentUser.assignedClasses)),
                new Promise((res, rej) => google.script.run.withSuccessHandler(res).withFailureHandler(rej).getUnverifiedRecords('ALL'))
            ]).then(([stats, pendingApprovals, pendingBonusDeductions]) => {
                hideLoading();
                renderSuperAdminDashboardUI(stats, pendingApprovals, pendingBonusDeductions, startStr, endStr);
            }).catch(e => {
                hideLoading();
                showToast('Error', e.message, 'error');
            });
        }

        function renderSuperAdminDashboardUI(stats, pendingApprovals, pendingBonusDeductions, startStr, endStr) {
    const contentArea = document.getElementById('contentArea');
    const t = translations[currentLanguage];

    // --- CRASH FIX: Default all arrays to empty if they are null ---
    stats = stats || {};
    stats.topOffenses = stats.topOffenses || [];
    stats.topClasses = stats.topClasses || [];
    stats.totalCDR = stats.totalCDR || 0;
    stats.level1 = stats.level1 || 0;
    stats.level2 = stats.level2 || 0;
    stats.totalLateness = stats.totalLateness || 0;
    stats.activityLate = stats.activityLate || 0;
    stats.realLate = stats.realLate || 0;

    pendingApprovals = pendingApprovals || [];
    pendingBonusDeductions = pendingBonusDeductions || [];
    // -------------------------------------------------------------

    // 1. Bonus Deduction Queue (Real Late)
    let bonusSection = '';
    const realLateRecords = pendingBonusDeductions.filter(r => r.type === 'Real Late');

    if (realLateRecords.length > 0) {
        bonusSection = `
        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r shadow-md mb-6 animate-pulse">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-red-900 flex items-center gap-2">
                    üö® Pending Bonus Deductions (Real Late) <span class="bg-red-200 text-red-900 text-xs px-2 py-0.5 rounded-full">${realLateRecords.length}</span>
                </h3>
            </div>
            <div class="bg-white rounded border overflow-hidden max-h-64 overflow-y-auto">
                ${realLateRecords.map(r => `
                    <div class="flex justify-between items-center p-3 border-b last:border-0 hover:bg-gray-50">
                        <div>
                            <div class="font-bold text-gray-800">${r.studentName} <span class="text-gray-500 font-normal">(${r.class})</span></div>
                            <div class="text-xs text-gray-500">${new Date(r.timestamp).toLocaleTimeString()} ‚Ä¢ ${r.type} ‚Ä¢ ${r.reason}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="verifyItem('${r.id}', 'Reject')" class="text-xs text-gray-500 hover:text-red-500 underline px-2">Skip/Restore</button>
                            <button onclick="verifyItem('${r.id}', 'Approve')" class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded shadow hover:bg-red-700">Deduct Bonus</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>`;
    }

    // 2. Parent Meeting Approval Queue
    let approvalSection = '';
    if (pendingApprovals.length > 0) {
        approvalSection = `
        <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r shadow-md mb-6 animate-pulse">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-amber-900 flex items-center gap-2">
                    üõéÔ∏è Pending Parent Meetings <span class="bg-amber-200 text-amber-900 text-xs px-2 py-0.5 rounded-full">${pendingApprovals.length}</span>
                </h3>
            </div>
            <div class="bg-white rounded border overflow-hidden">
                ${pendingApprovals.map(req => `
                    <div class="flex justify-between items-center p-3 border-b last:border-0 hover:bg-gray-50">
                        <div>
                            <div class="font-bold text-gray-800">${req.studentName} <span class="text-gray-500 font-normal">(${req.class})</span></div>
                            <div class="text-xs text-gray-500">Requested: ${new Date(req.requestedDate).toLocaleDateString()} ‚Ä¢ Level: ${req.level}</div>
                            <div class="text-sm text-gray-700 italic mt-1">"${req.description || 'Parent Meeting Requested'}"</div>
                        </div>
                        <div>
                            <button onclick="approveRequest('${req.id}')" class="px-4 py-2 bg-amber-600 text-white text-sm font-bold rounded shadow hover:bg-amber-700 transition">Approve</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>`;
    }

    contentArea.innerHTML = `
    <div class="space-y-6">
        ${bonusSection}
        ${approvalSection}
        <div class="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-gray-200">
            <div>
                <h2 class="text-xl font-bold text-gray-800">üìä ${currentLanguage === 'th' ? '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'School Overview'}</h2>
                <p class="text-sm text-gray-500">${startStr} to ${endStr}</p>
            </div>
            <div class="flex gap-2 mt-4 md:mt-0">
                <button onclick="loadSuperAdminDashboard()" class="px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 font-bold transition">üîÑ Refresh</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500">
                <p class="text-gray-500 text-xs uppercase">${t.totalCDR}</p>
                <h3 class="text-3xl font-bold text-blue-800 mt-1">${stats.totalCDR}</h3>
                <div class="flex gap-2 mt-2 text-xs font-bold">
                    <span class="text-yellow-600 bg-yellow-100 px-2 py-0.5 rounded">L1: ${stats.level1}</span>
                    <span class="text-red-600 bg-red-100 px-2 py-0.5 rounded">L2: ${stats.level2}</span>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-orange-500">
                <p class="text-gray-500 text-xs uppercase">${t.latenessRecord}</p>
                <h3 class="text-3xl font-bold text-orange-800 mt-1">${stats.totalLateness}</h3>
                <div class="flex gap-2 mt-2 text-xs font-bold">
                    <span class="text-orange-600 bg-orange-100 px-2 py-0.5 rounded">Act: ${stats.activityLate}</span>
                    <span class="text-red-600 bg-red-100 px-2 py-0.5 rounded">Real: ${stats.realLate}</span>
                </div>
            </div>
            
             <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-purple-500">
                <p class="text-gray-500 text-xs uppercase">Top Offense</p>
                <h3 class="text-lg font-bold text-purple-800 mt-1 truncate">${stats.topOffenses.length > 0 ? stats.topOffenses[0].label : '-'}</h3>
                <p class="text-xs text-gray-400 mt-1">${stats.topOffenses.length > 0 ? stats.topOffenses[0].count + ' incidents' : ''}</p>
            </div>

             <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-teal-500">
                <p class="text-gray-500 text-xs uppercase">Top Class</p>
                <h3 class="text-3xl font-bold text-teal-800 mt-1">${stats.topClasses.length > 0 ? stats.topClasses[0].label : '-'}</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">üìâ Most Common Offenses</h3>
                <div class="space-y-3">
                    ${stats.topOffenses.map((o, idx) => `
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-600"><span class="mr-2 font-mono text-gray-400">#${idx + 1}</span> ${o.label}</span>
                            <span class="text-sm font-bold bg-gray-100 px-2 py-1 rounded-full">${o.count}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-1.5"><div class="bg-blue-500 h-1.5 rounded-full" style="width: ${(o.count / (stats.totalCDR || 1)) * 100}%"></div></div>
                    `).join('')}
                    ${stats.topOffenses.length === 0 ? '<p class="text-sm text-gray-400 italic">No records found.</p>' : ''}
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">üè´ Most Active Classes</h3>
                 <div class="space-y-3">
                    ${stats.topClasses.map((c, idx) => `
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-600"><span class="mr-2 font-mono text-gray-400">#${idx + 1}</span> ${c.label}</span>
                            <span class="text-sm font-bold bg-gray-100 px-2 py-1 rounded-full">${c.count}</span>
                        </div>
                         <div class="w-full bg-gray-100 rounded-full h-1.5"><div class="bg-teal-500 h-1.5 rounded-full" style="width: ${(c.count / (stats.totalCDR || 1)) * 100}%"></div></div>
                    `).join('')}
                     ${stats.topClasses.length === 0 ? '<p class="text-sm text-gray-400 italic">No records found.</p>' : ''}
                </div>
            </div>
        </div>
    </div>
    `;
}

        function approveRequest(cdrId) {
            showLoading('Approving...');
            google.script.run.withSuccessHandler((res) => {
                hideLoading();
                if (res.success) {
                    showToast('Approved', res.message, 'success');
                    loadSuperAdminDashboard(); // Refresh
                } else {
                    showToast('Error', res.message, 'error');
                }
            }).approveParentMeeting(cdrId, currentUser.fullName);
        }

        function loadTeacherDashboard() {
            showLoading();
            let targetClasses = currentUser.assignedClasses;
            const role = currentUser.role;
            const t = translations[currentLanguage];

            const dashboardFilter = {
                status: 'Pending',
                classIds: currentUser.assignedClasses.split(','),
                date: new Date().toISOString().split('T')[0]
            };

            Promise.all([
                new Promise((res, rej) => google.script.run.withSuccessHandler(res).withFailureHandler(rej).getDashboardStats(currentUser.role, targetClasses, currentUser.username)),
                new Promise((res, rej) => google.script.run.withSuccessHandler(res).withFailureHandler(rej).getLatenessSummaryForHRT(dashboardFilter)),
                new Promise((res, rej) => google.script.run.withSuccessHandler(res).withFailureHandler(rej).getClassScores(targetClasses))
            ]).then(([stats, latenessResult, studentScores]) => {
                hideLoading();
                const contentArea = document.getElementById('contentArea');

                // --- AT-RISK MONITOR ---
                const atRiskStudents = studentScores.filter(s => s.score < 80);
                let atRiskHtml = '';
                if (atRiskStudents.length > 0) {
                    let rows = atRiskStudents.map(s => {
                        let scoreClass = s.score < 50 ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';
                        return `<tr class="border-b hover:bg-gray-50"><td class="py-2 px-3 text-sm font-bold">${s.name} <span class="text-xs font-normal text-gray-500">(${s.id})</span></td><td class="py-2 px-3 text-center text-gray-600">${s.class}</td><td class="py-2 px-3 text-center"><span class="px-2 py-1 rounded-full font-bold text-xs ${scoreClass}">${s.score}/100</span></td></tr>`;
                    }).join('');
                    atRiskHtml = `<div class="bg-white rounded-lg shadow-md border-t-4 border-red-500 overflow-hidden mb-6"><div class="p-4 bg-red-50 border-b flex justify-between items-center"><div class="flex items-center"><span class="text-2xl mr-2">‚ö†Ô∏è</span><h3 class="font-bold text-red-800">${currentLanguage === 'th' ? '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô < 80)' : 'At-Risk Students (Score < 80)'}</h3></div><span class="bg-red-200 text-red-800 font-bold text-sm px-3 py-1 rounded-full">${atRiskStudents.length}</span></div><div class="max-h-64 overflow-y-auto"><table class="w-full"><tbody>${rows}</tbody></table></div></div>`;
                } else {
                    atRiskHtml = `<div class="bg-green-50 rounded-lg p-4 mb-6 border border-green-200 font-bold text-green-800">‚úÖ ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏û‡∏§‡∏ï‡∏¥‡∏î‡∏µ (80+)</div>`;
                }

                // --- WORKFLOW STATS ---
                const completionRate = (stats.pendingCases + stats.resolvedCases) > 0 ? Math.round((stats.resolvedCases / (stats.pendingCases + stats.resolvedCases)) * 100) : 100;
                const workflowHtml = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-yellow-400">
                        <p class="text-gray-500 text-xs uppercase">${currentLanguage === 'th' ? '‡πÄ‡∏Ñ‡∏™‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢' : 'Pending Cases'}</p>
                        <h3 class="text-3xl font-bold text-yellow-600 mt-1">${stats.pendingCases}</h3>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-green-500">
                        <p class="text-gray-500 text-xs uppercase">${currentLanguage === 'th' ? '‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : 'Resolved Cases'}</p>
                        <h3 class="text-3xl font-bold text-green-600 mt-1">${stats.resolvedCases}</h3>
                        <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2"><div class="bg-green-500 h-1.5 rounded-full" style="width: ${completionRate}%"></div></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-orange-500">
                        <p class="text-gray-500 text-xs uppercase">${t.latenessToday}</p>
                        <h3 class="text-3xl font-bold text-orange-600 mt-1">${latenessResult.todayPendingCount || 0}</h3>
                        ${role === 'HRT' && latenessResult.todayPendingCount > 0 ? `<button onclick="loadManageLatenessPage()" class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded mt-2 hover:bg-orange-200 transition">üëâ ${currentLanguage === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ' : 'Manage Now'}</button>` : ''}
                    </div>
                </div>`;

                // Render Dashboard
                contentArea.innerHTML = atRiskHtml + workflowHtml + `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200 flex items-center justify-between"><div><p class="text-gray-500 text-xs uppercase">${t.totalCDR}</p><p class="text-2xl font-bold text-gray-800">${stats.totalCDR}</p></div><div class="text-2xl opacity-50">üìù</div></div>
                        <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200 flex items-center justify-between"><div><p class="text-gray-500 text-xs uppercase">${t.level1Cases}</p><p class="text-2xl font-bold text-yellow-600">${stats.level1}</p></div><div class="text-2xl opacity-50">‚ö†Ô∏è</div></div>
                        <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200 flex items-center justify-between"><div><p class="text-gray-500 text-xs uppercase">${t.level2Cases}</p><p class="text-2xl font-bold text-red-600">${stats.level2}</p></div><div class="text-2xl opacity-50">üö®</div></div>
                    </div>
                    <div class="text-center text-xs text-gray-400 mt-8">Smart CDR System v2.1 ‚Ä¢ Last Updated: ${new Date().toLocaleTimeString()}</div>
                `;
            }).catch(err => {
                hideLoading();
                document.getElementById('contentArea').innerHTML = `<div class="bg-red-100 text-red-700 p-6 rounded-lg text-center"><h3 class="font-bold mb-2">Error Loading Dashboard</h3><p>${err}</p></div>`;
            });
        }

        // --- HRT VERIFICATION HELPERS (Global Scope) ---

        // [OFFICE] Modal for HRT to Log Action on Activity Late
        window.showLogActionModal = function (id, studentName, strikeCount) {
            let title = '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢ (Activity Late)';
            
            // 1. Define Exact Strings (Business Rules)
            const msgStrike1 = 'Strike 1: ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏Å‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á';
            const msgStrike2 = 'Strike 2: ‡∏á‡∏î‡πÄ‡∏ö‡∏£‡∏Ñ (Lunch Detention) + ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏±‡∏î‡∏û‡∏ö';
            const msgStrike3 = 'Strike 3: ‡πÄ‡∏ä‡∏¥‡∏ç‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á + ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ (3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)';

            // 2. Logic: Determine which action is "Recommended" (Default Selected)
            let suggestion = '';
            let icon = '‚ÑπÔ∏è';
            let defaultActionValue = 'Other'; // Default fallthrough

            if (strikeCount === 1) {
                suggestion = msgStrike1;
                icon = '‚ö†Ô∏è';
                defaultActionValue = msgStrike1; // Auto-select Strike 1 Message
            } else if (strikeCount === 2) {
                suggestion = msgStrike2;
                icon = 'üç±';
                defaultActionValue = msgStrike2; // Auto-select Strike 2 Message
            } else if (strikeCount >= 3) {
                suggestion = msgStrike3;
                icon = 'üö®';
                defaultActionValue = msgStrike3; // Auto-select Strike 3 Message
            }

            let htmlContent = `
                <div class="text-left space-y-4">
                    <div class="bg-blue-50 p-3 rounded border border-blue-100 flex items-start gap-3">
                        <div class="text-2xl">${icon}</div>
                        <div>
                            <div class="font-bold text-blue-900">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏¢: ${strikeCount}</div>
                            <div class="text-sm text-blue-800 font-bold mt-1">${suggestion}</div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (Select Action)</label>
                        <select id="swal_hrt_action" class="w-full border p-2 rounded bg-white focus:ring-2 focus:ring-blue-500">
                            <option value="${msgStrike1}" ${defaultActionValue === msgStrike1 ? 'selected' : ''}>
                                ${msgStrike1}
                            </option>
                            
                            <option value="${msgStrike2}" ${defaultActionValue === msgStrike2 ? 'selected' : ''}>
                                ${msgStrike2}
                            </option>
                            
                            <option value="${msgStrike3}" ${defaultActionValue === msgStrike3 ? 'selected' : ''}>
                                ${msgStrike3}
                            </option>
                            
                            <option value="‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (Other)">‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (Other)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Notes)</label>
                        <textarea id="swal_hrt_notes" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                    </div>
                </div>
            `;

            Swal.fire({
                title: title,
                html: htmlContent,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#2563eb',
                cancelButtonColor: '#6b7280',
                preConfirm: () => {
                    const action = document.getElementById('swal_hrt_action').value;
                    const notes = document.getElementById('swal_hrt_notes').value;
                    if (!action) return Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
                    return { action, notes };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'); 
                    
                    google.script.run
                        .withSuccessHandler((res) => {
                            hideLoading();
                            if (res.success) {
                                Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', res.message, 'success');
                                if (typeof loadManageLatenessPage === 'function') {
                                    loadManageLatenessPage(); 
                                }
                            } else {
                                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.message, 'error');
                            }
                        })
                        .logHrtAction(id, result.value.action, result.value.notes, currentUser.fullName);
                }
            });
        };

        function renderVerificationQueue(records) {
            const contentArea = document.getElementById('contentArea');

            // Create the container
            const queueHtml = `
        <div class="bg-orange-50 border-l-4 border-orange-500 p-4 rounded-r shadow-md mb-6 animate-pulse" id="verificationQueuePanel">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-orange-800 flex items-center gap-2">
                    ‚ö†Ô∏è Pending Verification <span class="bg-orange-200 text-orange-800 text-xs px-2 py-0.5 rounded-full">${records.length}</span>
                </h3>
            </div>
            <div class="bg-white rounded border overflow-hidden">
                ${records.map(r => `
                    <div class="flex justify-between items-center p-3 border-b last:border-0 hover:bg-gray-50">
                        <div>
                            <div class="font-bold text-gray-800">${r.studentName}</div>
                            <div class="text-xs text-gray-500">${new Date(r.timestamp).toLocaleTimeString()} ‚Ä¢ ${r.type} ‚Ä¢ ${r.recordedBy}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="verifyItem('${r.id}', 'Reject')" class="p-2 text-red-500 hover:bg-red-50 rounded">‚úï</button>
                            <button onclick="verifyItem('${r.id}', 'Approve')" class="px-3 py-1 bg-green-600 text-white text-sm font-bold rounded shadow hover:bg-green-700">Approve</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        `;

            // Prepend to contentArea
            contentArea.insertAdjacentHTML('afterbegin', queueHtml);
        }

        function verifyItem(recordId, action) {
            showLoading(action === 'Approve' ? 'Approving...' : 'Rejecting...');
            google.script.run.withSuccessHandler(() => {
                hideLoading();
                showToast('Success', `Record ${action}d`, 'success');
                // Remove the specific row or reload dashboard. 
                // Reloading is safer to sync state:
                loadDashboard();
            }).verifyIncident(recordId, action, currentUser.fullName);
        }


        function renderRapidEntryPage() {
            const contentArea = document.getElementById('contentArea');
            const todayStr = new Date().toISOString().split('T')[0];

            // Reset selection state
            selectedRapidReason = '';

            contentArea.innerHTML = `
    <div class="max-w-2xl mx-auto space-y-4">
        <div class="bg-blue-600 text-white p-4 rounded-lg shadow-md flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold flex items-center gap-2">
                    ‚ö° ${currentLanguage === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢ (‡∏î‡πà‡∏ß‡∏ô)' : 'Rapid Entry'}
                </h2>
                <p class="text-blue-100 text-sm mt-1">${currentLanguage === 'th' ? '‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô' : 'For On-Duty Teachers'}</p>
            </div>
            <div class="text-right">
                <div class="text-2xl font-mono font-bold" id="liveClock">--:--</div>
                <div class="text-xs text-blue-200">${new Date().toLocaleDateString('th-TH')}</div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
            <div class="space-y-4">
                
                <div>
                    <label class="block text-gray-700 font-bold mb-1">${currentLanguage === 'th' ? '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'Class'}</label>
                    <select id="rapidClass" onchange="handleRapidClassChange()" class="w-full text-lg px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500 bg-gray-50">
                        <option value="">${currentLanguage === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...' : 'Loading...'}</option>
                    </select>
                </div>

                <div>
                    <label class="block text-gray-700 font-bold mb-1">${currentLanguage === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô / ‡∏£‡∏´‡∏±‡∏™' : 'Student Name / ID'}</label>
                    <input list="rapidStudentsList" id="rapidStudentName" 
                           class="w-full text-lg px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500" 
                           placeholder="${currentLanguage === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...' : 'Select class first...'}">
                    <datalist id="rapidStudentsList">
                        </datalist>
                </div>

                <div>
                    <label class="block text-gray-700 font-bold mb-2">${currentLanguage === 'th' ? '‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢' : 'Reason'}</label>
                    <div class="flex flex-wrap gap-2" id="reasonChipsContainer">
                        <button type="button" onclick="selectReasonChip('‡∏£‡∏ñ‡∏ï‡∏¥‡∏î')" id="chip_traffic"
                            class="reason-chip px-4 py-2 rounded-full border border-gray-300 bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
                            üöó ‡∏£‡∏ñ‡∏ï‡∏¥‡∏î
                        </button>
                        <button type="button" onclick="selectReasonChip('‡∏ï‡∏∑‡πà‡∏ô‡∏™‡∏≤‡∏¢')" id="chip_overslept"
                            class="reason-chip px-4 py-2 rounded-full border border-gray-300 bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
                            üò¥ ‡∏ï‡∏∑‡πà‡∏ô‡∏™‡∏≤‡∏¢
                        </button>
                        <button type="button" onclick="selectReasonChip('‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏∞')" id="chip_errand"
                            class="reason-chip px-4 py-2 rounded-full border border-gray-300 bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
                            üìù ‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏∞
                        </button>
                        <button type="button" onclick="selectReasonChip('‡∏≠‡∏∑‡πà‡∏ô ‡πÜ')" id="chip_other"
                            class="reason-chip px-4 py-2 rounded-full border border-gray-300 bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
                            ‚úèÔ∏è ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
                        </button>
                    </div>

                    <div id="otherReasonContainer" class="hidden mt-3 transition-all duration-300 origin-top">
                        <input type="text" id="manualReasonInput" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                               placeholder="${currentLanguage === 'th' ? '‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏...' : 'Specify reason...'}">
                    </div>
                </div>

                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg mt-4">
                    <input type="date" id="rapidDate" value="${todayStr}" class="bg-transparent border-none text-gray-600 font-medium focus:ring-0">
                    <div class="flex items-center">
                        <input type="checkbox" id="keepFormOpen" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                        <label for="keepFormOpen" class="ml-2 text-sm font-bold text-gray-700 select-none cursor-pointer">
                            ${currentLanguage === 'th' ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏ß‡πâ' : 'Keep Form Open'}
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mt-6">
                    <button onclick="submitRapidEntry('7:40')" class="flex flex-col items-center justify-center p-4 bg-yellow-100 border-2 border-yellow-400 text-yellow-800 rounded-xl hover:bg-yellow-200 active:scale-95 transition-all shadow-sm">
                        <span class="text-2xl mb-1">‚è∞</span>
                        <span class="font-bold text-lg">Late 7:40</span>
                        <span class="text-xs opacity-75">Activity Late</span>
                    </button>

                    <button onclick="submitRapidEntry('8:00')" class="flex flex-col items-center justify-center p-4 bg-red-100 border-2 border-red-400 text-red-800 rounded-xl hover:bg-red-200 active:scale-95 transition-all shadow-sm">
                        <span class="text-2xl mb-1">üö®</span>
                        <span class="font-bold text-lg">Late 8:00+</span>
                        <span class="text-xs opacity-75">Real Late</span>
                    </button>
                </div>
            </div>
        </div>
        <div id="rapidLog" class="text-xs text-gray-400 text-center mt-4"></div>
    </div>
    `;

            // Initialize Clock
            const clockInterval = setInterval(() => {
                const el = document.getElementById('liveClock');
                if (el) el.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                else clearInterval(clockInterval);
            }, 1000);

            // Call the helper function immediately
            loadClassesForRapidEntry();
        }

        function selectReasonChip(reason) {
            selectedRapidReason = reason;
            const chips = document.querySelectorAll('.reason-chip');
            const container = document.getElementById('otherReasonContainer');
            const input = document.getElementById('manualReasonInput');
            const textarea = document.getElementById('lateReason'); // For Office Staff View

            // 1. Reset all chips styling
            chips.forEach(chip => {
                chip.className = 'reason-chip px-4 py-2 rounded-full border border-gray-300 bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors';
            });

            // 2. Highlight selected chip (by matching partial ID or text)
            // Simple ID mapping
            let chipId = '';
            if (reason === '‡∏£‡∏ñ‡∏ï‡∏¥‡∏î') chipId = 'chip_traffic';
            else if (reason === '‡∏ï‡∏∑‡πà‡∏ô‡∏™‡∏≤‡∏¢') chipId = 'chip_overslept';
            else if (reason === '‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏∞') chipId = 'chip_errand';
            else if (reason === '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ') chipId = 'chip_other';

            // Also try to find chip by ID if used in Office View
            if (!chipId) chipId = 'chip_' + reason;

            const activeChip = document.getElementById(chipId);
            if (activeChip) {
                activeChip.className = 'reason-chip px-4 py-2 rounded-full border border-blue-600 bg-blue-600 text-white shadow-md transition-colors';
            }

            // 3. Logic for Rapid Entry (Others Toggle)
            if (container && input) {
                if (reason === '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ') {
                    container.classList.remove('hidden');
                    setTimeout(() => input.focus(), 50);
                } else {
                    container.classList.add('hidden');
                    input.value = '';
                }
            }

            // 4. Logic for Office Staff View (Auto-fill Textarea)
            if (textarea) {
                if (reason !== '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ') {
                    textarea.value = reason;
                } else {
                    textarea.value = '';
                    textarea.placeholder = currentLanguage === 'th' ? '‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏...' : 'Specify reason...';
                    textarea.focus();
                }
            }
        }

        // --- MISSING HELPERS FOR RAPID ENTRY ---

        function loadClassesForRapidEntry() {
            // Check if google.script.run is available
            if (typeof google === 'undefined') return;

            google.script.run.withSuccessHandler(function (classes) {
                const select = document.getElementById('rapidClass');
                if (!select) return;

                select.innerHTML = `<option value="">${currentLanguage === 'th' ? '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --' : '-- Select Class --'}</option>`;
                classes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    select.appendChild(opt);
                });
            }).getAllClasses();
        }

        function handleRapidClassChange() {
            const classId = document.getElementById('rapidClass').value;
            const datalist = document.getElementById('rapidStudentsList');
            const input = document.getElementById('rapidStudentName');

            datalist.innerHTML = '';
            input.value = '';
            input.placeholder = currentLanguage === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...' : 'Loading list...';

            if (!classId) return;

            // Use Cache if available
            if (studentCache[classId]) {
                populateRapidDatalist(studentCache[classId]);
                input.placeholder = currentLanguage === 'th' ? '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...' : 'Type to search...';
                return;
            }

            google.script.run.withSuccessHandler(function (students) {
                studentCache[classId] = students; // Save to cache
                populateRapidDatalist(students);
                input.placeholder = currentLanguage === 'th' ? '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...' : 'Type to search...';
            }).getStudentsByClass(classId);
        }

        function populateRapidDatalist(students) {
            const datalist = document.getElementById('rapidStudentsList');
            students.forEach(s => {
                const opt = document.createElement('option');
                opt.value = `${s.studentId} : ${s.name}`;
                datalist.appendChild(opt);
            });
        }

        function submitRapidEntry(type) {
            const classVal = document.getElementById('rapidClass').value;
            const studentVal = document.getElementById('rapidStudentName').value;
            const dateVal = document.getElementById('rapidDate').value;
            const keepOpen = document.getElementById('keepFormOpen').checked;

            // Reason Logic
            let finalReason = selectedRapidReason;
            if (selectedRapidReason === '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ') {
                const manualInput = document.getElementById('manualReasonInput');
                if (manualInput && !manualInput.value.trim()) {
                    showToast(currentLanguage === 'th' ? '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö' : 'Missing Info', currentLanguage === 'th' ? '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏' : 'Please specify reason', 'warning');
                    manualInput.focus();
                    return;
                }
                finalReason = manualInput.value.trim();
            } else if (!finalReason) {
                showToast(currentLanguage === 'th' ? '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö' : 'Missing Info', currentLanguage === 'th' ? '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏' : 'Please select a reason', 'warning');
                return;
            }

            if (!classVal || !studentVal) {
                showToast('Error', currentLanguage === 'th' ? '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'Select class and student', 'warning');
                return;
            }

            const parts = studentVal.split(' : ');
            if (parts.length < 2) {
                showToast('Error', 'Invalid format', 'error');
                return;
            }
            const studentId = parts[0].trim();
            const studentName = parts[1].trim();

            const record = {
                studentId: studentId,
                studentName: studentName,
                class: classVal,
                time: new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }),
                reason: finalReason,
                recordedBy: currentUser.fullName,
                recordType: type,
                status: 'Pending',
                date: dateVal
            };

            showLoading(currentLanguage === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : 'Saving...');

            google.script.run.withSuccessHandler(function (result) {
                hideLoading();
                if (result.success) {
                    // Check for Action Message
                    if (result.action) {
                        Swal.fire({
                            title: 'Recorded',
                            text: `Student: ${studentName}\n\n${result.action}`,
                            icon: result.action.includes('CRITICAL') ? 'warning' : 'info',
                            timer: 4000
                        });
                    } else {
                        showToast('Saved', `${studentName} - ${type}`, 'success');
                    }
                    const logEl = document.getElementById('rapidLog');
                    if (logEl) logEl.innerHTML = `‚úÖ Last: ${studentName} (${type}) - ${finalReason}`;

                    if (keepOpen) {
                        // Reset Student Input only
                        document.getElementById('rapidStudentName').value = '';
                        document.getElementById('rapidStudentName').focus();

                        // RESET CHIPS Logic as requested
                        selectedRapidReason = '';
                        document.getElementById('manualReasonInput').value = '';
                        document.getElementById('otherReasonContainer').classList.add('hidden');
                        document.querySelectorAll('.reason-chip').forEach(c => {
                            c.className = 'reason-chip px-4 py-2 rounded-full border border-gray-300 bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors';
                        });
                    } else {
                        // Reset All
                        renderRapidEntryPage(); // Re-render is safest to clear everything
                    }
                } else {
                    showToast('Error', result.message, 'error');
                }
            }).saveLatenessRecord(record);
        }

        // --- ADMIN CONSOLE (Tabs: Config, Users, Students) ---

        function loadSystemSettingsPage() {
            showLoading();
            google.script.run.withSuccessHandler(function (result) {
                hideLoading();
                if (result.success) {
                    renderAdminConsole(result.config);
                } else {
                    Swal.fire('Error', result.message, 'error');
                }
            }).getSystemConfig();
        }

        function renderAdminConsole(config) {
            const contentArea = document.getElementById('contentArea');

            // 1. Render The Tabbed Layout
            contentArea.innerHTML = `
    <div class="max-w-7xl mx-auto">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">üõ†Ô∏è ${currentLanguage === 'th' ? '‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö' : 'Admin Console'}</h2>

        <div class="flex border-b border-gray-200 mb-6 bg-white rounded-t-lg shadow-sm">
            <button onclick="switchAdminTab('config')" id="tab_btn_config" class="admin-tab-btn px-6 py-3 font-semibold text-blue-600 border-b-2 border-blue-600 bg-blue-50">
                ‚öôÔ∏è ${currentLanguage === 'th' ? '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö' : 'Config'}
            </button>
            <button onclick="switchAdminTab('users')" id="tab_btn_users" class="admin-tab-btn px-6 py-3 font-semibold text-gray-500 hover:text-blue-600">
                üë• ${currentLanguage === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' : 'Users'}
            </button>
            <button onclick="switchAdminTab('students')" id="tab_btn_students" class="admin-tab-btn px-6 py-3 font-semibold text-gray-500 hover:text-blue-600">
                üéì ${currentLanguage === 'th' ? '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'Students'}
            </button>
        </div>

        <div id="tab_content_config" class="admin-tab-content">
            <div id="config_ui_placeholder"></div>
        </div>

        <div id="tab_content_users" class="admin-tab-content hidden">
            <div class="flex justify-end mb-4">
                <button onclick="openUserModal()" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 font-bold">
                    + ${currentLanguage === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' : 'Add User'}
                </button>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
                        <tr>
                            <th class="p-3">Username</th>
                            <th class="p-3">Name</th>
                            <th class="p-3">Role</th>
                            <th class="p-3">Class</th>
                            <th class="p-3">PIN</th>
                            <th class="p-3">Status</th>
                            <th class="p-3 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="user_table_body" class="text-sm text-gray-600">
                        <tr><td colspan="7" class="p-4 text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="tab_content_students" class="admin-tab-content hidden">
             <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
                        <tr>
                            <th class="p-3">ID</th>
                            <th class="p-3">Name</th>
                            <th class="p-3">Class</th>
                            <th class="p-3">Status</th>
                        </tr>
                    </thead>
                    <tbody id="student_table_body" class="text-sm text-gray-600">
                        <tr><td colspan="4" class="p-4 text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>`;

            // 2. Initialize Config Tab (Calendar)
            renderConfigTabContent(config);

            // 3. Lazy Load Data
            loadAdminUsers();
            loadAdminStudents();
        }

        // --- TAB SWITCHER ---
        window.switchAdminTab = function (tabName) {
            document.querySelectorAll('.admin-tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.admin-tab-btn').forEach(el => {
                el.className = 'admin-tab-btn px-6 py-3 font-semibold text-gray-500 hover:text-blue-600 border-b-2 border-transparent';
            });
            document.getElementById(`tab_content_${tabName}`).classList.remove('hidden');
            document.getElementById(`tab_btn_${tabName}`).className = 'admin-tab-btn px-6 py-3 font-semibold text-blue-600 border-b-2 border-blue-600 bg-blue-50';
        }

        // --- CONFIG TAB LOGIC (Restored from your code) ---
        function renderConfigTabContent(config) {
            const container = document.getElementById('config_ui_placeholder');
            const currentYear = new Date().getFullYear();
            const thaiYear = currentYear + 543;
            const months = currentLanguage === 'th' ? ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'] : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            function generateCalendar(year, yearLabel) {
                let html = '';
                for (let m = 0; m < 12; m++) {
                    const daysInMonth = new Date(year, m + 1, 0).getDate();
                    const firstDay = new Date(year, m, 1).getDay();
                    const monthKey = `${year}-${String(m + 1).padStart(2, '0')}`;

                    html += `<div class="bg-white rounded border p-2 month-calendar" data-month="${monthKey}">
                <div class="text-center font-bold text-blue-800 text-sm mb-1">${months[m]} ${yearLabel}</div>
                <div class="grid grid-cols-7 gap-1 text-[10px] text-center text-gray-400"><div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div></div>
                <div class="grid grid-cols-7 gap-1 text-xs mt-1">`;
                    for (let i = 0; i < firstDay; i++) html += `<div></div>`;
                    for (let d = 1; d <= daysInMonth; d++) {
                        const dateStr = `${monthKey}-${String(d).padStart(2, '0')}`;
                        const isHoliday = config.holidays && config.holidays.includes(dateStr);
                        const dayClass = isHoliday ? 'bg-red-500 text-white font-bold' : 'hover:bg-blue-100 text-gray-700 cursor-pointer';
                        html += `<div onclick="toggleHoliday('${dateStr}', this)" class="rounded py-1 text-center transition-colors ${dayClass}">${d}</div>`;
                    }
                    html += `</div></div>`;
                }
                return html;
            }

            container.innerHTML = `
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-lg shadow-md h-fit">
            <h3 class="font-bold text-lg mb-4 text-blue-600">üìÖ Academic Terms</h3>
            <div class="space-y-4">
                <div><label class="block text-sm font-bold text-gray-700">Academic Year</label><input type="text" id="conf_year" value="${config.academicYear || ''}" class="w-full border p-2 rounded"></div>
                <div><label class="block text-sm font-bold text-gray-700">Semester 1</label><div class="flex gap-2"><input type="month" id="conf_s1_start" value="${config.semester1Start || ''}" class="w-1/2 border p-2 rounded text-sm sem-input"> - <input type="month" id="conf_s1_end" value="${config.semester1End || ''}" class="w-1/2 border p-2 rounded text-sm sem-input"></div></div>
                <div><label class="block text-sm font-bold text-gray-700">Semester 2</label><div class="flex gap-2"><input type="month" id="conf_s2_start" value="${config.semester2Start || ''}" class="w-1/2 border p-2 rounded text-sm sem-input"> - <input type="month" id="conf_s2_end" value="${config.semester2End || ''}" class="w-1/2 border p-2 rounded text-sm sem-input"></div></div>
                <button onclick="handleSystemConfigSubmit()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow mt-4">üíæ Save Settings</button>
            </div>
        </div>
        <div class="lg:col-span-2 bg-gray-50 p-6 rounded-lg border border-gray-200">
            <h3 class="font-bold text-lg text-red-600 mb-4">üóìÔ∏è Holiday Calendar</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 max-h-[600px] overflow-y-auto pr-2">
                ${generateCalendar(currentYear, thaiYear)}
                ${generateCalendar(currentYear + 1, thaiYear + 1)}
            </div>
        </div>
    </div>`;

            window.tempHolidays = config.holidays || [];
        }

        window.toggleHoliday = function (dateStr, el) {
            const idx = window.tempHolidays.indexOf(dateStr);
            if (idx > -1) {
                window.tempHolidays.splice(idx, 1);
                el.className = 'rounded py-1 text-center transition-colors hover:bg-blue-100 text-gray-700 cursor-pointer';
            } else {
                window.tempHolidays.push(dateStr);
                el.className = 'rounded py-1 text-center transition-colors bg-red-500 text-white font-bold';
            }
        }

        window.handleSystemConfigSubmit = function () {
            const payload = {
                academicYear: document.getElementById('conf_year').value,
                semester1Start: document.getElementById('conf_s1_start').value,
                semester1End: document.getElementById('conf_s1_end').value,
                semester2Start: document.getElementById('conf_s2_start').value,
                semester2End: document.getElementById('conf_s2_end').value,
                holidays: window.tempHolidays
            };
            showLoading();
            google.script.run.withSuccessHandler(() => { hideLoading(); Swal.fire('Saved', 'Configuration updated', 'success'); }).saveSystemConfig(payload);
        }

        // --- USERS TAB LOGIC ---
        function loadAdminUsers() {
            google.script.run.withSuccessHandler(users => {
                const tbody = document.getElementById('user_table_body');
                if (!tbody) return;
                tbody.innerHTML = users.map(u => `
            <tr class="border-b hover:bg-gray-50">
                <td class="p-3 font-mono font-bold text-blue-600">${u.username}</td>
                <td class="p-3">${u.fullName}</td>
                <td class="p-3"><span class="px-2 py-1 rounded bg-gray-200 text-xs font-bold">${u.role}</span></td>
                <td class="p-3 text-xs">${u.classes || 'ALL'}</td>
                <td class="p-3 font-mono text-xs text-gray-400">****${String(u.pin).slice(-2)}</td>
                <td class="p-3">${u.status === 'Active' ? '‚úÖ' : '‚ùå'}</td>
                <td class="p-3 text-right">
                    <button onclick='openUserModal(${JSON.stringify(u)})' class="text-blue-600 hover:underline text-xs mr-2">Edit</button>
                    <button onclick="deleteAdminUser('${u.username}')" class="text-red-600 hover:underline text-xs">Delete</button>
                </td>
            </tr>
        `).join('');
            }).getAllUsers();
        }

        window.openUserModal = function (user = null) {
            const isEdit = !!user;
            Swal.fire({
                title: isEdit ? 'Edit User' : 'Add New User',
                html: `
            <div class="space-y-3 text-left">
                <div><label class="text-xs font-bold">Username</label><input id="swal_user" class="w-full border p-2 rounded" value="${user?.username || ''}" ${isEdit ? 'disabled bg-gray-100' : ''}></div>
                <div><label class="text-xs font-bold">Password</label><input id="swal_pass" type="password" class="w-full border p-2 rounded" value="${user?.password || ''}"></div>
                <div><label class="text-xs font-bold">Full Name</label><input id="swal_name" class="w-full border p-2 rounded" value="${user?.fullName || ''}"></div>
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-xs font-bold">Role</label>
                    <select id="swal_role" class="w-full border p-2 rounded">
                        <option value="Teacher" ${user?.role === 'Teacher' ? 'selected' : ''}>Teacher</option>
                        <option value="HRT" ${user?.role === 'HRT' ? 'selected' : ''}>HRT</option>
                        <option value="VP" ${user?.role === 'VP' ? 'selected' : ''}>VP</option>
                        <option value="OfficeStaff" ${user?.role === 'OfficeStaff' ? 'selected' : ''}>OfficeStaff</option>
                        <option value="Superadmin" ${user?.role === 'Superadmin' ? 'selected' : ''}>Superadmin</option>
                        <option value="OnDutyTeacher" ${user?.role === 'OnDutyTeacher' ? 'selected' : ''}>OnDutyTeacher</option>
                    </select></div>
                    <div><label class="text-xs font-bold">PIN (4-Digit)</label><input id="swal_pin" maxlength="4" class="w-full border p-2 rounded" value="${user?.pin || ''}"></div>
                </div>
                <div><label class="text-xs font-bold">Assigned Class (e.g. M.1/1 or ALL)</label><input id="swal_class" class="w-full border p-2 rounded" value="${user?.classes || ''}"></div>
                <div><label class="text-xs font-bold">Email</label><input id="swal_email" class="w-full border p-2 rounded" value="${user?.email || ''}"></div>
            </div>`,
                showCancelButton: true, confirmButtonText: 'Save',
                preConfirm: () => {
                    return {
                        username: document.getElementById('swal_user').value,
                        password: document.getElementById('swal_pass').value,
                        fullName: document.getElementById('swal_name').value,
                        role: document.getElementById('swal_role').value,
                        classes: document.getElementById('swal_class').value,
                        email: document.getElementById('swal_email').value,
                        pin: document.getElementById('swal_pin').value,
                        status: 'Active', isEdit: isEdit
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    google.script.run.withSuccessHandler(() => { hideLoading(); loadAdminUsers(); Swal.fire('Saved', '', 'success'); }).saveUser(result.value);
                }
            });
        }

        window.deleteAdminUser = function (username) {
            Swal.fire({ title: 'Delete User?', text: "Cannot be undone!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    google.script.run.withSuccessHandler(() => { hideLoading(); loadAdminUsers(); }).deleteUser(username);
                }
            });
        }


        // --- STUDENTS TAB LOGIC ---
        function loadAdminStudents() {
            google.script.run.withSuccessHandler(students => {
                const tbody = document.getElementById('student_table_body');
                if (!tbody) return;

                // Add "Add Student" button if not already there (helper check)
                const tabContent = document.getElementById('tab_content_students');
                if (tabContent && !document.getElementById('btnAddStudent')) {
                    const btnDiv = document.createElement('div');
                    btnDiv.className = 'flex justify-end mb-4';
                    btnDiv.innerHTML = `<button id="btnAddStudent" onclick="openStudentModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow text-sm">+ ${currentLanguage === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'Add New Student'}</button>`;
                    tabContent.insertBefore(btnDiv, tabContent.firstChild);
                }

                // Update Table Headers if needed (Action Column)
                const theadRow = document.querySelector('#tab_content_students thead tr');
                if (theadRow && theadRow.children.length === 4) {
                    const th = document.createElement('th');
                    th.className = "p-4 text-right";
                    th.textContent = "Actions";
                    theadRow.appendChild(th);
                }

                tbody.innerHTML = students.slice(0, 50).map(s => `
            <tr class="border-b hover:bg-gray-50">
                <td class="p-3 font-mono">${s.id}</td>
                <td class="p-3">${s.name}</td>
                <td class="p-3">${s.class}</td>
                <td class="p-3 text-xs"><span class="px-2 py-1 rounded ${s.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} font-bold">${s.status}</span></td>
                <td class="p-3 text-right">
                    <button onclick='openStudentModal(${JSON.stringify(s)})' class="text-blue-600 hover:underline text-xs mr-2">Edit</button>
                    <button onclick="deleteStudent('${s.id}')" class="text-red-600 hover:underline text-xs">Delete</button>
                </td>
            </tr>
        `).join('') + (students.length > 50 ? '<tr><td colspan="5" class="p-2 text-center text-gray-400 text-xs">Showing first 50...</td></tr>' : '');
            }).getAllStudentsAdmin();
        }

        window.openStudentModal = function (student = null) {
            const isEdit = !!student;
            Swal.fire({
                title: isEdit ? 'Edit Student' : 'Add New Student',
                html: `
            <div class="space-y-3 text-left">
                <div><label class="text-xs font-bold">Student ID</label><input id="swal_sid" class="w-full border p-2 rounded" value="${student?.id || ''}" ${isEdit ? 'disabled bg-gray-100' : ''}></div>
                <div><label class="text-xs font-bold">Full Name</label><input id="swal_sname" class="w-full border p-2 rounded" value="${student?.name || ''}"></div>
                <div><label class="text-xs font-bold">Class</label><input id="swal_sclass" class="w-full border p-2 rounded" value="${student?.class || ''}" placeholder="e.g. M.1/1"></div>
                <div><label class="text-xs font-bold">Status</label>
                    <select id="swal_sstatus" class="w-full border p-2 rounded">
                        <option value="Active" ${student?.status === 'Active' ? 'selected' : ''}>Active</option>
                        <option value="Inactive" ${student?.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                        <option value="Graduated" ${student?.status === 'Graduated' ? 'selected' : ''}>Graduated</option>
                    </select>
                </div>
            </div>`,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Save',
                preConfirm: () => {
                    const id = document.getElementById('swal_sid').value;
                    const name = document.getElementById('swal_sname').value;
                    const cls = document.getElementById('swal_sclass').value;
                    if (!id || !name || !cls) {
                        Swal.showValidationMessage('Please fill all fields');
                        return false;
                    }
                    return {
                        id: id,
                        name: name,
                        class: cls,
                        status: document.getElementById('swal_sstatus').value,
                        isEdit: isEdit
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    google.script.run.withSuccessHandler((res) => {
                        hideLoading();
                        if (res.success) {
                            loadAdminStudents();
                            Swal.fire('Saved', '', 'success');
                        } else {
                            Swal.fire('Error', res.message, 'error');
                        }
                    }).saveStudentAdmin(result.value);
                }
            });
        }

        window.deleteStudent = function (id) {
            Swal.fire({ title: 'Delete Student?', text: "Cannot be undone!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    google.script.run.withSuccessHandler((res) => {
                        hideLoading();
                        if (res.success) {
                            loadAdminStudents();
                        } else {
                            Swal.fire('Error', res.message, 'error');
                        }
                    }).deleteStudentAdmin(id);
                }
            });
        }

        // --- RE-IMPLEMENTING PLACEHOLDER FUNCTIONS ---

        function loadOfficeDashboard() {
            showLoading(currentLanguage === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á...' : 'Loading parent meetings...');
            google.script.run.withSuccessHandler(function (meetings) {
                hideLoading();
                renderParentMeetingsTable(meetings);
            }).getPendingParentMeetings();
        }

        function loadStudentDashboard() {
            showLoading();
            google.script.run.withSuccessHandler(function (stats) {
                hideLoading();
                const contentArea = document.getElementById('contentArea');
                const score = stats.behaviorScore !== undefined ? stats.behaviorScore : 100;
                let scoreColorClass = score >= 80 ? 'bg-green-100 border-green-500 text-green-800' : (score >= 50 ? 'bg-yellow-100 border-yellow-500 text-yellow-800' : 'bg-red-100 border-red-500 text-red-800');
                let scoreIcon = score >= 80 ? 'üåü' : (score >= 50 ? '‚ö†Ô∏è' : 'üö®');

                contentArea.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 ${scoreColorClass.split(' ')[1]}">
                        <div class="flex items-center justify-between">
                            <div><p class="text-sm font-semibold text-gray-600">Behavior Score</p><p class="text-4xl font-bold mt-1">${score}/100</p></div>
                            <div class="text-4xl p-3 rounded-full ${scoreColorClass.split(' ')[0]}">${scoreIcon}</div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 ${stats.bonusStatus === 'Eligible' ? 'border-green-500' : 'border-red-500'}">
                        <p class="text-sm font-semibold">${currentLanguage === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏ö‡∏ô‡∏±‡∏™' : 'Bonus Status'}</p>
                        <p class="text-2xl font-bold mt-1">${stats.bonusStatus}</p>
                    </div>
                </div>
            `;
            }).getDashboardStats(currentUser.role, currentUser.assignedClasses, currentUser.username);
        }

        function loadCDRPage() {
    // Render the Container & Controls
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = `
<div class="max-w-7xl mx-auto">
     <div class="flex flex-col md:flex-row justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">üìù ${currentLanguage === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ CDR' : 'CDR Management'}</h2>
            <p class="text-gray-500 text-sm">System-wide Discipline Log</p>
        </div>
    </div>

    <!-- Filter Toolbar -->
    <div class="bg-white p-4 rounded-lg shadow-sm mb-6 border border-gray-200 grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
           <label class="block text-xs font-bold text-gray-500 mb-1">Search</label>
           <input type="text" id="cdrFilterSearch" onkeyup="debounce(fetchCDRData, 500)" placeholder="Student Name or ID..." class="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
        </div>
        <div>
           <label class="block text-xs font-bold text-gray-500 mb-1">Level</label>
           <select id="cdrFilterLevel" onchange="fetchCDRData()" class="w-full border p-2 rounded text-sm bg-gray-50">
               <option value="">All Levels</option>
               <option value="Level 1">Level 1 (General)</option>
               <option value="Level 2">Level 2 (Serious)</option>
           </select>
        </div>
         <div>
           <label class="block text-xs font-bold text-gray-500 mb-1">Status</label>
           <select id="cdrFilterStatus" onchange="fetchCDRData()" class="w-full border p-2 rounded text-sm bg-gray-50">
               <option value="">All Statuses</option>
               <option value="OPEN">Open / Active</option>
               <option value="DONE">Resolved</option>
           </select>
        </div>
         <div class="flex items-end">
            <button onclick="fetchCDRData()" class="w-full bg-blue-50 text-blue-600 font-bold py-2 rounded hover:bg-blue-100 transition">Filter</button>
        </div>
    </div>

    <!-- Data Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden min-h-[400px]">
        <div class="table-container" style="overflow-x: auto; -webkit-overflow-scrolling: touch; width: 100%;">
            <table class="min-w-[700px] w-full text-left border-collapse">
                <thead class="bg-gray-100 text-gray-700 uppercase text-xs sticky top-0">
                    <tr>
                        <th class="p-4 border-b whitespace-nowrap">Date</th>
                        <th class="p-4 border-b whitespace-nowrap">Student</th>
                        <th class="p-4 border-b whitespace-nowrap">Level</th>
                        <th class="p-4 border-b whitespace-nowrap">Strike</th>
                        <th class="p-4 border-b whitespace-nowrap">Offense / Punishment</th>
                        <th class="p-4 border-b whitespace-nowrap">Status</th>
                        <th class="p-4 border-b text-right whitespace-nowrap">Action</th>
                    </tr>
                </thead>
                <tbody id="cdrTableBody" class="text-sm text-gray-600">
                    <tr><td colspan="7" class="p-8 text-center text-gray-400">Loading data...</td></tr>
                </tbody>
            </table>
        </div>
         <div class="p-4 border-t border-gray-100 flex justify-between items-center bg-gray-50">
            <span class="text-xs text-gray-400" id="cdrCountLabel">Showing 0 records</span>
            <div class="flex gap-2">
                <button id="btnPrev" onclick="changeCDRPage(-1)" class="px-3 py-1 bg-white border rounded hover:bg-gray-50 disabled:opacity-50 text-xs" disabled>Previous</button>
                <button id="btnNext" onclick="changeCDRPage(1)" class="px-3 py-1 bg-white border rounded hover:bg-gray-50 disabled:opacity-50 text-xs" disabled>Next</button>
            </div>
        </div>
    </div>
</div>
`;

    // Load Initial Data
    window.cdrCurrentOffset = 0;
    window.cdrPageSize = 25;
    fetchCDRData();
}

        // Debounce Utility
        window.debounce = function (func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        };


      window.fetchCDRData = function (resetPage = true) {
          if (resetPage) window.cdrCurrentOffset = 0;

          const search = document.getElementById('cdrFilterSearch').value;
          const level = document.getElementById('cdrFilterLevel').value;
          const status = document.getElementById('cdrFilterStatus').value;

          const filter = {
              role: currentUser.role,
              assignedClasses: currentUser.assignedClasses,
              offset: window.cdrCurrentOffset,
              limit: window.cdrPageSize,
              offenseType: level === 'Level 1' ? 'A' : (level === 'Level 2' ? 'B' : ''),
              status: status
          };

          const tbody = document.getElementById('cdrTableBody');
          tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-400"><div class="animate-pulse">Fetching records...</div></td></tr>';

          google.script.run.withSuccessHandler(response => {
              if (response && response.success) {
                  // --- CRASH FIX: Ensure response.data is an array ---
                  const data = response.data || []; 
                  // --------------------------------------------------
                  
                  renderCDRTable(data, search);

                  document.getElementById('btnPrev').disabled = window.cdrCurrentOffset === 0;
                  document.getElementById('btnNext').disabled = data.length < window.cdrPageSize;
                  document.getElementById('cdrCountLabel').textContent = `Showing ${data.length} records`;
              } else {
                  tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-red-500">Error: ${response ? response.message : 'Unknown Error'}</td></tr>`;
              }
          }).getCDRRecords(filter);
      }

        window.changeCDRPage = function (direction) {
            window.cdrCurrentOffset += (direction * window.cdrPageSize);
            if (window.cdrCurrentOffset < 0) window.cdrCurrentOffset = 0;
            fetchCDRData(false);
        }

        function renderCDRTable(records, searchText) {
            const tbody = document.getElementById('cdrTableBody');

            // Client-Side Search Filtering
            if (searchText) {
                const lowerInfo = searchText.toLowerCase();
                records = records.filter(r =>
                    (r.studentName && r.studentName.toLowerCase().includes(lowerInfo)) ||
                    (r.studentId && r.studentId.toString().includes(lowerInfo)) ||
                    (r.class && r.class.toLowerCase().includes(lowerInfo))
                );
            }

            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400">No matching records found.</td></tr>';
                return;
            }

            tbody.innerHTML = records.map(r => {
                const dateObj = new Date(r.date);
                const dateStr = dateObj.toLocaleDateString('en-GB'); // DD/MM/YYYY
                const statusColor = r.status === 'Resolved' || r.status === 'Done' ? 'bg-green-100 text-green-700 border-green-200' : 'bg-blue-50 text-blue-600 border-blue-100';
                const levelBadge = r.level === 'Level 1' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800 font-bold';

                return `
            <tr class="border-b hover:bg-gray-50 transition-colors group">
                <td class="p-4 whitespace-nowrap text-gray-500">${dateStr}</td>
                <td class="p-4">
                    <div class="font-bold text-gray-800">${r.studentName}</div>
                    <div class="text-xs text-gray-400">${r.class}</div>
                </td>
                <td class="p-4"><span class="px-2 py-1 rounded-full text-xs ${levelBadge}">${r.level}</span></td>
                <td class="p-4 text-center"><span class="px-2 py-1 rounded-full text-xs bg-gray-100 font-bold">${r.offenseCount}</span></td>
                <td class="p-4">
                    <div class="text-gray-700 font-medium">${r.category || r.description || '-'}</div>
                    <div class="text-xs text-gray-400 mt-1">Punishment: ${r.punishment || '-'}</div>
                </td>
                <td class="p-4"><span class="px-2 py-1 rounded border text-xs ${statusColor}">${r.status}</span></td>
                <td class="p-4 text-right">
                    ${r.status !== 'Resolved' && r.status !== 'Done' && currentUser.role !== 'Teacher' ?
                        `<button onclick="resolveCDRCase('${r.id}')" class="text-blue-600 hover:text-blue-800 text-xs font-bold border border-blue-200 px-3 py-1 rounded hover:bg-blue-50 transition mr-2">Resolve</button>`
                        : ''}
                    
                    ${(currentUser.role === 'HRT' || currentUser.role === 'VP' || currentUser.role === 'Superadmin') && r.level === 'Level 2' && (!r.parentMeetingRequested || r.parentMeetingRequested === 'FALSE') ?
                        `<button onclick="triggerParentMeeting('${r.id}')" class="text-red-600 hover:text-red-800 text-xs font-bold border border-red-200 px-3 py-1 rounded hover:bg-red-50 transition">Request Meeting</button>`
                        : ''}
                </td>
            </tr>`;
            }).join('');
        }

        window.resolveCDRCase = function (id) {
            Swal.fire({
                title: 'Resolve Case',
                input: 'textarea',
                inputPlaceholder: 'Enter resolution notes...',
                showCancelButton: true,
                confirmButtonText: 'Mark Resolved',
                confirmButtonColor: '#10B981'
            }).then((result) => {
                if (result.isConfirmed) {
                    const notes = result.value || 'Resolved via Admin Panel';
                    showLoading('Resolving...');
                    google.script.run.withSuccessHandler(res => {
                        hideLoading();
                        if (res.success) {
                            Swal.fire('Success', 'Case resolved.', 'success');
                            // Context-Aware Refresh
                            if (window.currentPage === 'myClassCDR') {
                                loadMyClassCDR();
                            } else {
                                fetchCDRData(false);
                            }
                        } else {
                            Swal.fire('Error', res.message, 'error');
                        }
                    }).resolveCDR(id, notes, currentUser.fullName);
                }
            });
        }

        function loadMyClassCDR() {
            showLoading(currentLanguage === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CDR ‡∏´‡πâ‡∏≠‡∏á‡∏â‡∏±‡∏ô...' : 'Loading My Class CDR...');
            const t = translations[currentLanguage];
            const contentArea = document.getElementById('contentArea');

            // Render Filter UI First (Responsive & Clean)
            contentArea.innerHTML = `
        <div class="max-w-7xl mx-auto">
             <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">üìã ${currentLanguage === 'th' ? '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° (‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô)' : 'My Class CDR History'}</h2>
                    <p class="text-gray-500 text-sm">Viewing records for: <span class="font-mono font-bold text-blue-600">${currentUser.assignedClasses}</span></p>
                </div>
            </div>

            <!-- Filter Toolbar -->
            <div class="bg-white p-4 rounded-lg shadow-sm mb-6 border border-gray-200 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                   <label class="block text-xs font-bold text-gray-500 mb-1">${t.search}</label>
                   <input type="text" id="myCdrFilterSearch" onkeyup="filterMyClassCDR()" placeholder="Student Name or ID..." class="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                   <label class="block text-xs font-bold text-gray-500 mb-1">Level</label>
                   <select id="myCdrFilterLevel" onchange="filterMyClassCDR()" class="w-full border p-2 rounded text-sm bg-gray-50">
                       <option value="">All Levels</option>
                       <option value="Level 1">Level 1 (General)</option>
                       <option value="Level 2">Level 2 (Serious)</option>
                   </select>
                </div>
                 <div class="md:col-span-2 flex items-end justify-end">
                    <span class="text-xs text-gray-400 italic mr-2" id="myCdrCountLabel">Loading...</span>
                </div>
            </div>

            <!-- Data Table -->
            <div class="table-container" style="overflow-x: auto; -webkit-overflow-scrolling: touch; width: 100%; margin-bottom: 15px;">
  <table class="w-full border-collapse border border-gray-200">
    <thead class="bg-blue-50">
      <tr>
        <th class="border border-gray-200 p-2 text-left text-sm font-medium text-blue-600">DATE</th>
        <th class="border border-gray-200 p-2 text-left text-sm font-medium text-blue-600">STUDENT</th>
        <th class="border border-gray-200 p-2 text-left text-sm font-medium text-blue-600">LEVEL</th>
        <th class="border border-gray-200 p-2 text-left text-sm font-medium text-blue-600">STRIKE</th>
        <th class="border border-gray-200 p-2 text-left text-sm font-medium text-blue-600">OFFENSE</th>
        <th class="border border-gray-200 p-2 text-left text-sm font-medium text-blue-600">STATUS</th>
        <th class="border border-gray-200 p-2 text-left text-sm font-medium text-blue-600">RECORDED BY</th>
        <th class="border border-gray-200 p-2 text-left text-sm font-medium text-blue-600">ACTIONS</th>
      </tr>
                    </thead>
                    <tbody id="myCdrTableBody" class="text-sm text-gray-600">
                        <tr><td colspan="6" class="p-8 text-center text-gray-400"><div class="animate-pulse">Fetching records...</div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>`;

            // Fetch Data
            const filter = { context: 'myClassCDR', role: currentUser.role, teacherEmail: currentUser.email, classIds: currentUser.assignedClasses ? currentUser.assignedClasses.split(',') : [], limit: 200 };

            google.script.run.withSuccessHandler(function (response) {
                hideLoading();
                let records = response.success ? response.data : (Array.isArray(response) ? response : []);
                window.myClassCDRData = records; // Store for client-side filtering

                // Initial Render
                renderMyClassCDRTable(records);
            }).withFailureHandler(function (error) {
                hideLoading();
                Swal.fire('Error', 'Failed to load data: ' + error.message, 'error');
            }).getCDRRecords(filter);
        }

        function filterMyClassCDR() {
            if (!window.myClassCDRData) return;

            const search = document.getElementById('myCdrFilterSearch').value.toLowerCase();
            const level = document.getElementById('myCdrFilterLevel').value;

            const filtered = window.myClassCDRData.filter(r => {
                const matchesSearch = (r.studentName && r.studentName.toLowerCase().includes(search)) ||
                    (r.studentId && String(r.studentId).includes(search));
                const matchesLevel = level ? r.level === level : true;
                return matchesSearch && matchesLevel;
            });

            renderMyClassCDRTable(filtered);
        }

        function renderMyClassCDRTable(records) {
            const tbody = document.getElementById('myCdrTableBody');
            document.getElementById('myCdrCountLabel').textContent = `Showing ${records.length} records`;

            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400">No matching records found.</td></tr>';
                return;
            }

            tbody.innerHTML = records.map(r => {
                const dateObj = new Date(r.date);
                const dateStr = dateObj.toLocaleDateString('en-GB');
                const statusColor = r.status === 'Resolved' || r.status === 'Done' || r.status === 'Completed' ? 'bg-green-100 text-green-700 border-green-200' : 'bg-blue-50 text-blue-600 border-blue-100';
                const levelBadge = r.level === 'Level 1' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800 font-bold';

                return `
            <tr class="border-b hover:bg-gray-50 transition-colors group">
                <td class="p-4 whitespace-nowrap text-gray-500">${dateStr}</td>
                <td class="p-4">
                    <div class="font-bold text-gray-800">${r.studentName}</div>
                    <div class="text-xs text-gray-400">${r.studentId} ‚Ä¢ ${r.class}</div>
                </td>
                <td class="p-4"><span class="px-2 py-1 rounded-full text-xs ${levelBadge}">${r.level}</span></td>
                <td class="p-4 text-center"><span class="px-2 py-1 rounded-full text-xs bg-gray-100 font-bold">${r.offenseCount}</span></td>
                <td class="p-4">
                    <div class="text-gray-700 font-medium">${r.category || r.description || '-'}</div>
                    <div class="text-xs text-gray-400 mt-1">Punishment: ${r.punishment || '-'}</div>
                </td>
                <td class="p-4"><span class="px-2 py-1 rounded border text-xs ${statusColor}">${r.status}</span></td>
                <td class="p-4 text-right">
                    ${r.status !== 'Resolved' && r.status !== 'Completed' ?
                        `<button onclick="resolveCDRCase('${r.id}')" class="text-blue-600 hover:text-blue-800 text-xs font-bold border border-blue-200 px-3 py-1 rounded hover:bg-blue-50 transition mr-2">Resolve</button>`
                        : ''}
                    
                    ${r.level === 'Level 2' && (!r.parentMeetingRequested || String(r.parentMeetingRequested).toUpperCase() === 'FALSE') ?
                        `<button onclick="triggerParentMeeting('${r.id}')" class="text-red-600 hover:text-red-800 text-xs font-bold border border-red-200 px-3 py-1 rounded hover:bg-red-50 transition">Request Meeting</button>`
                        : ''}
                     ${r.level === 'Level 2' && (r.parentMeetingRequested && String(r.parentMeetingRequested).toUpperCase() === 'TRUE') ?
                        `<span class="text-xs text-orange-500 font-bold border border-orange-200 px-2 py-1 rounded bg-orange-50">Pending VP</span>`
                        : ''}
                </td>
            </tr>`;
            }).join('');
        }

        function triggerParentMeeting(cdrId) {
            Swal.fire({
                title: 'Request Parent Meeting?',
                text: "This will send the request to the VP Approval Queue.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Yes, Request Meeting'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading('Sending Request...');
                    google.script.run.withSuccessHandler((res) => {
                        hideLoading();
                        if (res.success) {
                            Swal.fire('Requested', res.message, 'success');
                            // Context-Aware Refresh
                            if (window.currentPage === 'myClassCDR') {
                                loadMyClassCDR();
                            } else {
                                fetchCDRData(false);
                            }
                        } else {
                            Swal.fire('Error', res.message, 'error');
                        }
                    }).requestParentMeeting(cdrId, currentUser.fullName);
                }
            });
        }

        function loadLatenessPage() {
            const t = translations[currentLanguage];
            document.getElementById('pageTitle').textContent = t.latenessRecord;
            const contentArea = document.getElementById('contentArea');
            const role = currentUser.role;

            // Use Rapid Entry for OnDutyTeacher
            if (role === 'OnDutyTeacher') {
                renderRapidEntryPage();
                return;
            }
            const today = new Date().toISOString().split('T')[0];
            const currentTime = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

            contentArea.innerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6 max-w-2xl mx-auto">
            <h2 class="text-xl font-bold mb-4">‚è±Ô∏è ${currentLanguage === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≤‡∏¢‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (8:00 ‡∏ô.)' : 'School Lateness (8:00 AM)'}</h2>
            
            <form onsubmit="handleLatenessSubmit(event)" class="space-y-4">
                <input type="hidden" id="lateRecordType" value="8:00">

                <div>
                    <label class="block text-gray-700 font-semibold mb-1">${currentLanguage === 'th' ? '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'Class'}</label>
                    <select id="lateClassSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required onchange="loadStudentsForLateness()">
                        <option value="">${currentLanguage === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...' : 'Loading...'}</option>
                    </select>
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-1">${currentLanguage === 'th' ? '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'Student'}</label>
                    <select id="lateStudentSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50" required disabled>
                        <option value="">--</option>
                    </select>
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">${currentLanguage === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏î‡πà‡∏ß‡∏ô' : 'Quick Reason'}</label>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" onclick="selectReasonChip('‡∏£‡∏ñ‡∏ï‡∏¥‡∏î')" id="chip_traffic" class="reason-chip px-3 py-1 rounded-full border border-gray-300 bg-gray-50 text-sm hover:bg-gray-100">üöó ‡∏£‡∏ñ‡∏ï‡∏¥‡∏î</button>
                        <button type="button" onclick="selectReasonChip('‡∏ï‡∏∑‡πà‡∏ô‡∏™‡∏≤‡∏¢')" id="chip_overslept" class="reason-chip px-3 py-1 rounded-full border border-gray-300 bg-gray-50 text-sm hover:bg-gray-100">üò¥ ‡∏ï‡∏∑‡πà‡∏ô‡∏™‡∏≤‡∏¢</button>
                        <button type="button" onclick="selectReasonChip('‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏∞')" id="chip_errand" class="reason-chip px-3 py-1 rounded-full border border-gray-300 bg-gray-50 text-sm hover:bg-gray-100">üìù ‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏∞</button>
                        <button type="button" onclick="selectReasonChip('‡∏≠‡∏∑‡πà‡∏ô ‡πÜ')" id="chip_other" class="reason-chip px-3 py-1 rounded-full border border-gray-300 bg-gray-50 text-sm hover:bg-gray-100">‚úèÔ∏è ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</button>
                    </div>
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-1">${currentLanguage === 'th' ? '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•' : 'Reason'}</label>
                    <textarea id="lateReason" class="w-full px-4 py-2 border border-gray-300 rounded-lg" rows="2" required></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-1">${currentLanguage === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</label>
                        <input type="date" id="lateDate" value="${today}" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-1">${currentLanguage === 'th' ? '‡πÄ‡∏ß‡∏•‡∏≤' : 'Time'}</label>
                        <input type="time" id="lateTime" value="${currentTime}" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">
                    ${currentLanguage === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : 'Save'}
                </button>
            </form>
        </div>
        `;
            // Helper to load classes for Lateness Page
            google.script.run.withSuccessHandler(function (classes) {
                const select = document.getElementById('lateClassSelect');
                if (!select) return;
                select.innerHTML = `<option value="">${currentLanguage === 'th' ? '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --' : '-- Select Class --'}</option>`;
                classes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    select.appendChild(opt);
                });
            }).getAllClasses();
        }

        // --- ATTENDANCE FUNCTIONS ---

        function loadAttendancePage() {
            showLoading(currentLanguage === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠...' : 'Checking attendance data...');
            google.script.run.withSuccessHandler(function (attendanceToday) {
                google.script.run.withSuccessHandler(function (students) {
                    hideLoading();
                    if (!students || students.length === 0) {
                        Swal.fire('Info', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'info');
                        return;
                    }
                    renderAttendanceForm(students, attendanceToday);
                }).getStudentsByClass(currentUser.assignedClasses);
            }).getAttendanceForToday(currentUser.assignedClasses);
        }


        function renderAttendanceForm(students, attendanceToday) {
            const contentArea = document.getElementById('contentArea');
            const today = new Date().toLocaleDateString(currentLanguage === 'th' ? 'th-TH' : 'en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });

            const hasExistingData = attendanceToday && attendanceToday.length > 0;
            const attendanceMap = {};
            if (hasExistingData) {
                attendanceToday.forEach(record => { attendanceMap[record.studentId] = record.status; });
            }

            let mobileHtml = '';
            let desktopRows = '';

            students.forEach((student, index) => {
                const existingStatus = attendanceMap[student.studentId] || null;

                // Helper to generate buttons with unique IDs for this index
                const getButtons = (viewType) => `
                <div class="flex space-x-1 ${viewType === 'mobile' ? 'justify-between w-full mt-3' : 'justify-center'}">
                    <button onclick="setAttendanceStatus(${index}, 'present')" id="btn_present_${index}_${viewType}" class="flex-1 px-3 py-2 ${viewType === 'mobile' ? 'text-base' : 'text-sm'} rounded font-semibold transition ${existingStatus === 'present' ? 'bg-green-600 text-white' : 'border border-green-600 text-green-600 hover:bg-green-600 hover:text-white'}">‚úÖ ${currentLanguage === 'th' ? '‡∏°‡∏≤' : 'Present'}</button>
                    <button onclick="setAttendanceStatus(${index}, 'absent')" id="btn_absent_${index}_${viewType}" class="flex-1 px-3 py-2 ${viewType === 'mobile' ? 'text-base' : 'text-sm'} rounded font-semibold transition ${existingStatus === 'absent' ? 'bg-red-600 text-white' : 'border border-red-600 text-red-600 hover:bg-red-600 hover:text-white'}">‚ùå ${currentLanguage === 'th' ? '‡∏Ç‡∏≤‡∏î' : 'Absent'}</button>
                    <button onclick="setAttendanceStatus(${index}, 'leave')" id="btn_leave_${index}_${viewType}" class="flex-1 px-3 py-2 ${viewType === 'mobile' ? 'text-base' : 'text-sm'} rounded font-semibold transition ${existingStatus === 'leave' ? 'bg-yellow-600 text-white' : 'border border-yellow-600 text-yellow-600 hover:bg-yellow-600 hover:text-white'}">üìã ${currentLanguage === 'th' ? '‡∏•‡∏≤' : 'Leave'}</button>
                </div>`;

                // Mobile Card HTML
                mobileHtml += `
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 mb-3">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="font-bold text-gray-800 text-lg">${student.name}</div>
                        <div class="text-sm text-gray-400 font-mono">${student.studentId} ‚Ä¢ ${student.class}</div>
                    </div>
                </div>
                ${getButtons('mobile')}
            </div>`;

                // Desktop Table Row HTML
                desktopRows += `
            <tr class="border-b border-gray-200 hover:bg-gray-50">
                <td class="py-3 px-4 text-center font-mono text-sm">${student.studentId}</td>
                <td class="py-3 px-4">
                    <div class="font-semibold">${student.name}</div>
                    <div class="text-sm text-gray-500">${student.class}</div>
                </td>
                <td class="py-3 px-4">
                    ${getButtons('desktop')}
                </td>
            </tr>`;
            });

            contentArea.innerHTML = `
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">${currentLanguage === 'th' ? '‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠' : 'Attendance'}</h2>
        <p class="text-gray-600">${today}</p>
        <p class="text-sm text-gray-500 mt-1">${currentLanguage === 'th' ? '‡∏´‡πâ‡∏≠‡∏á: ' : 'Class: '}${currentUser.assignedClasses}</p>
        ${hasExistingData ? `<div class="mt-2 inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800">Found existing data</div>` : ''}
    </div>
    
    <div class="mb-4 flex flex-wrap gap-2 sticky top-[60px] z-10 bg-gray-50 py-2 -mx-4 px-4 md:static md:bg-transparent md:p-0">
        <button onclick="markAllPresent()" class="flex-1 md:flex-none bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 font-semibold shadow-sm">‚úÖ ${currentLanguage === 'th' ? '‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'All Present'}</button>
        <button onclick="clearAllAttendance()" class="flex-1 md:flex-none bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 font-semibold shadow-sm">‚ùå ${currentLanguage === 'th' ? '‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤' : 'Clear All'}</button>
    </div>

    <!-- Mobile View -->
    <div class="md:hidden">
        ${mobileHtml}
    </div>

    <!-- Desktop View -->
    <div class="hidden md:block bg-white rounded-lg shadow-md overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="py-3 px-4 text-left font-semibold text-gray-700">${currentLanguage === 'th' ? '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'Student ID'}</th>
                    <th class="py-3 px-4 text-left font-semibold text-gray-700">${currentLanguage === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•' : 'Name'}</th>
                    <th class="py-3 px-4 text-center font-semibold text-gray-700">${currentLanguage === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                </tr>
            </thead>
            <tbody>${desktopRows}</tbody>
        </table>
    </div>

    <div class="mt-6 sticky bottom-4 z-20 md:static md:bottom-auto">
        <button onclick="saveAttendance()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 text-xl shadow-lg transform transition active:scale-95">üíæ ${currentLanguage === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : 'Save'}</button>
    </div>`;

            window.attendanceData = students.map(student => ({
                studentId: student.studentId, studentName: student.name, class: student.class, status: attendanceMap[student.studentId] || null
            }));
            window.hasExistingAttendanceData = hasExistingData;
        }


        function setAttendanceStatus(index, status) {
            window.attendanceData[index].status = status;
            // Helper to update button styles visually for ALL 3 buttons
            ['present', 'absent', 'leave'].forEach(s => {
                // Update BOTH Mobile and Desktop buttons
                ['mobile', 'desktop'].forEach(view => {
                    const btn = document.getElementById(`btn_${s}_${index}_${view}`);
                    if (!btn) return;

                    const colors = { present: 'green', absent: 'red', leave: 'yellow' };
                    const color = colors[s];

                    if (s === status) {
                        btn.className = `flex-1 px-3 py-2 ${view === 'mobile' ? 'text-base' : 'text-sm'} rounded font-semibold transition bg-${color}-600 text-white`;
                    } else {
                        btn.className = `flex-1 px-3 py-2 ${view === 'mobile' ? 'text-base' : 'text-sm'} rounded font-semibold transition border border-${color}-600 text-${color}-600 hover:bg-${color}-600 hover:text-white`;
                    }
                });
            });
        }

        function markAllPresent() {
            if (!window.attendanceData) return;
            window.attendanceData.forEach((d, i) => setAttendanceStatus(i, 'present'));
        }

        function clearAllAttendance() {
            if (!window.attendanceData) return;
            window.attendanceData.forEach((d, i) => {
                d.status = null;
                ['present', 'absent', 'leave'].forEach(s => {
                    const btn = document.getElementById(`btn_${s}_${i}`);
                    if (!btn) return;
                    const colors = { present: 'green', absent: 'red', leave: 'yellow' };
                    const color = colors[s];
                    btn.className = `px-3 py-1 rounded text-sm font-semibold transition border border-${color}-600 text-${color}-600 hover:bg-${color}-600 hover:text-white`;
                });
            });
        }

        function saveAttendance() {
            showLoading();
            google.script.run.withSuccessHandler(() => { hideLoading(); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'); }).saveAttendance({ date: new Date().toISOString(), records: window.attendanceData, recordedBy: currentUser.fullName });
        }

        // --- TIDINESS FUNCTIONS ---

        function loadTidinessPage() {
            showLoading();
            google.script.run.withSuccessHandler(function (tidinessThisWeek) {
                google.script.run.withSuccessHandler(function (students) {
                    hideLoading();
                    renderTidinessForm(students, tidinessThisWeek);
                }).getStudentsByClass(currentUser.assignedClasses);
            }).getTidinessForCurrentWeek(currentUser.assignedClasses);
        }


        function renderTidinessForm(students, tidinessThisWeek) {
            const contentArea = document.getElementById('contentArea');
            const today = new Date().toLocaleDateString(currentLanguage === 'th' ? 'th-TH' : 'en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            const hasExistingData = tidinessThisWeek && tidinessThisWeek.length > 0;
            const tidinessMap = {};
            if (hasExistingData) {
                tidinessThisWeek.forEach(record => {
                    tidinessMap[record.studentId] = { hair: record.hair, nails: record.nails, uniform: record.uniform, bag: record.bag };
                });
            }

            let mobileHtml = '';
            let desktopRows = '';

            students.forEach((student, index) => {
                const existingData = tidinessMap[student.studentId] || {};

                // Helper to generate Select Inputs
                const getSelect = (field, val, viewType) => `
            <select id="${field}_${index}_${viewType}" class="w-full px-2 py-1 border border-gray-300 rounded text-sm bg-white" onchange="setTidiness(${index}, '${field}', this.value)">
                <option value="‡∏ú‡πà‡∏≤‡∏ô" ${val === '‡∏ú‡πà‡∏≤‡∏ô' || !val ? 'selected' : ''}>‡∏ú‡πà‡∏≤‡∏ô (Pass)</option>
                <option value="‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô" ${val === '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô' ? 'selected' : ''}>‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô (Fail)</option>
            </select>`;

                // Mobile Card
                mobileHtml += `
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 mb-3 block md:hidden">
                <div class="flex justify-between items-start mb-2">
                    <div class="font-bold text-gray-800">${student.name}</div>
                    <div class="text-xs text-gray-400 font-mono">${student.studentId}</div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500">Hair</label>
                        ${getSelect('hair', existingData.hair, 'mobile')}
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Nails</label>
                        ${getSelect('nails', existingData.nails, 'mobile')}
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Uniform</label>
                        ${getSelect('uniform', existingData.uniform, 'mobile')}
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Bag</label>
                        ${getSelect('bag', existingData.bag, 'mobile')}
                    </div>
                </div>
            </div>`;

                // Desktop Row
                desktopRows += `
            <tr class="border-b border-gray-200 hover:bg-gray-50">
                <td class="py-3 px-4 text-center font-mono text-sm">${student.studentId}</td>
                <td class="py-3 px-4">
                    <div class="font-semibold">${student.name}</div>
                    <div class="text-sm text-gray-500">${student.class}</div>
                </td>
                <td class="py-3 px-4 text-center">${getSelect('hair', existingData.hair, 'desktop')}</td>
                <td class="py-3 px-4 text-center">${getSelect('nails', existingData.nails, 'desktop')}</td>
                <td class="py-3 px-4 text-center">${getSelect('uniform', existingData.uniform, 'desktop')}</td>
                <td class="py-3 px-4 text-center">${getSelect('bag', existingData.bag, 'desktop')}</td>
            </tr>`;
            });

            contentArea.innerHTML = `
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">${currentLanguage === 'th' ? '‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' : 'Tidiness Check'}</h2>
        <p class="text-gray-600">${today}</p>
        <p class="text-sm text-gray-500 mt-1">${currentLanguage === 'th' ? '‡∏´‡πâ‡∏≠‡∏á: ' : 'Class: '}${currentUser.assignedClasses}</p>
        ${hasExistingData ? `<div class="mt-2 inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800">Found existing data</div>` : ''}
    </div>
    
    <div class="mb-4 flex flex-wrap gap-2 sticky top-[60px] z-10 bg-gray-50 py-2 -mx-4 px-4 md:static md:bg-transparent md:p-0">
        <button onclick="markAllTidinessPass()" class="flex-1 md:flex-none bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 font-semibold shadow-sm">‚úÖ ${currentLanguage === 'th' ? '‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'All Pass'}</button>
        <button onclick="clearAllTidiness()" class="flex-1 md:flex-none bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 font-semibold shadow-sm">‚ùå ${currentLanguage === 'th' ? '‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤' : 'Clear All'}</button>
    </div>

    <!-- Mobile View -->
    <div class="md:hidden">
        ${mobileHtml}
    </div>

    <!-- Desktop View -->
    <div class="hidden md:block bg-white rounded-lg shadow-md overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="py-3 px-4 text-left font-semibold text-gray-700">${currentLanguage === 'th' ? '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'ID'}</th>
                    <th class="py-3 px-4 text-left font-semibold text-gray-700">${currentLanguage === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•' : 'Name'}</th>
                    <th class="py-3 px-4 text-center font-semibold text-gray-700">üíá ${currentLanguage === 'th' ? '‡∏ú‡∏°' : 'Hair'}</th>
                    <th class="py-3 px-4 text-center font-semibold text-gray-700">üíÖ ${currentLanguage === 'th' ? '‡πÄ‡∏•‡πá‡∏ö' : 'Nails'}</th>
                    <th class="py-3 px-4 text-center font-semibold text-gray-700">üëî ${currentLanguage === 'th' ? '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢' : 'Uniform'}</th>
                    <th class="py-3 px-4 text-center font-semibold text-gray-700">üéí ${currentLanguage === 'th' ? '‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤' : 'Bag'}</th>
                </tr>
            </thead>
            <tbody>${desktopRows}</tbody>
        </table>
    </div>

    <div class="mt-6 sticky bottom-4 z-20 md:static md:bottom-auto">
        <button onclick="saveTidiness()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 text-xl shadow-lg transform transition active:scale-95">üíæ ${currentLanguage === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : 'Save'}</button>
    </div>`;

            window.tidinessData = students.map((student, index) => {
                const existingData = tidinessMap[student.studentId] || {};
                return { studentId: student.studentId, studentName: student.name, class: student.class, hair: existingData.hair || '‡∏ú‡πà‡∏≤‡∏ô', nails: existingData.nails || '‡∏ú‡πà‡∏≤‡∏ô', uniform: existingData.uniform || '‡∏ú‡πà‡∏≤‡∏ô', bag: existingData.bag || '‡∏ú‡πà‡∏≤‡∏ô' };
            });
            window.hasExistingTidinessData = hasExistingData;
        }


        function setTidiness(index, field, value) {
            // Update Data Model
            if (window.tidinessData && window.tidinessData[index]) {
                window.tidinessData[index][field] = value;
            }

            // Sync View: Update BOTH Mobile and Desktop inputs
            ['mobile', 'desktop'].forEach(view => {
                const el = document.getElementById(`${field}_${index}_${view}`);
                if (el) el.value = value;
            });
        }

        function markAllTidinessPass() {
            if (!window.tidinessData) return;
            window.tidinessData.forEach((record, index) => {
                record.hair = '‡∏ú‡πà‡∏≤‡∏ô'; record.nails = '‡∏ú‡πà‡∏≤‡∏ô'; record.uniform = '‡∏ú‡πà‡∏≤‡∏ô'; record.bag = '‡∏ú‡πà‡∏≤‡∏ô';
                ['hair', 'nails', 'uniform', 'bag'].forEach(f => {
                    setTidiness(index, f, '‡∏ú‡πà‡∏≤‡∏ô');
                });
            });
        }

        function clearAllTidiness() {
            if (!window.tidinessData) return;
            window.tidinessData.forEach((record, index) => {
                record.hair = '‡∏ú‡πà‡∏≤‡∏ô'; record.nails = '‡∏ú‡πà‡∏≤‡∏ô'; record.uniform = '‡∏ú‡πà‡∏≤‡∏ô'; record.bag = '‡∏ú‡πà‡∏≤‡∏ô';
                ['hair', 'nails', 'uniform', 'bag'].forEach(f => {
                    setTidiness(index, f, '‡∏ú‡πà‡∏≤‡∏ô');
                });
            });
        }

        function saveTidiness() {
            // No need to call updateTidinessData() as we are live-updating window.tidinessData
            showLoading();
            google.script.run.withSuccessHandler(() => { hideLoading(); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'); }).saveTidinessCheck({ date: new Date().toISOString(), records: window.tidinessData, recordedBy: currentUser.fullName });
        }

        // --- USER MANAGEMENT PAGE ---
        function loadUserManagementPage() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
    <div class="max-w-7xl mx-auto">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üë• ${currentLanguage === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô & ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'User & Student Management'}</h2>

        <!-- TABS -->
        <div class="flex border-b border-gray-200 mb-6 bg-white rounded-t-lg shadow-sm">
            <button onclick="switchAdminTab('users')" id="tab_btn_users" class="admin-tab-btn px-6 py-3 font-semibold text-blue-600 border-b-2 border-blue-600 bg-blue-50 transition-colors">
                Users (Staff)
            </button>
            <button onclick="switchAdminTab('students')" id="tab_btn_students" class="admin-tab-btn px-6 py-3 font-semibold text-gray-500 hover:text-blue-600 border-b-2 border-transparent transition-colors">
                Students
            </button>
        </div>

        <!-- USERS TAB -->
        <div id="tab_content_users" class="admin-tab-content">
            <div class="flex justify-end mb-4">
                <button onclick="openUserModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow text-sm">
                    + ${currentLanguage === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' : 'Add New User'}
                </button>
            </div>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-blue-50 text-blue-800 uppercase text-xs font-bold border-b border-blue-100">
                        <tr>
                            <th class="p-4">Username</th>
                            <th class="p-4">Full Name</th>
                            <th class="p-4">Role</th>
                            <th class="p-4">Assigned Classes</th>
                            <th class="p-4">PIN</th>
                            <th class="p-4">Status</th>
                            <th class="p-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="user_table_body" class="text-sm text-gray-600 divide-y divide-gray-100">
                        <tr><td colspan="7" class="p-8 text-center text-gray-400">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- STUDENTS TAB -->
        <div id="tab_content_students" class="admin-tab-content hidden">
             <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-green-50 text-green-800 uppercase text-xs font-bold border-b border-green-100">
                        <tr>
                            <th class="p-4">ID</th>
                            <th class="p-4">Name</th>
                            <th class="p-4">Class</th>
                            <th class="p-4">Status</th>
                        </tr>
                    </thead>
                    <tbody id="student_table_body" class="text-sm text-gray-600 divide-y divide-gray-100">
                        <tr><td colspan="4" class="p-8 text-center text-gray-400">Loading students...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>`;

            loadAdminUsers();
            loadAdminStudents();
        }

        function loadSystemSettingsPage() {
            showLoading();
            google.script.run
                .withSuccessHandler(function (result) {
                    hideLoading();
                    if (result && result.success) {
                        renderSystemSettingsForm(result.config);
                    } else {
                        // If null or failed, fallback to defaults instead of blocking user
                        console.warn('Backend returned null/error for config. Using defaults.', result);
                        const defaultConfig = { academicYear: '', semester1Start: '', semester1End: '', semester2Start: '', semester2End: '', holidays: [] };
                        renderSystemSettingsForm(defaultConfig);

                        // Optional: Show toast so they know it failed to load existing
                        if (result && result.message) {
                            Swal.fire({ icon: 'warning', title: 'Warning', text: 'Could not load existing settings. ' + result.message, timer: 3000 });
                        }
                    }
                })
                .withFailureHandler(function (error) {
                    hideLoading();
                    Swal.fire({
                        icon: 'error',
                        title: currentLanguage === 'th' ? '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' : 'Error',
                        text: error,
                        confirmButtonText: currentLanguage === 'th' ? '‡∏õ‡∏¥‡∏î' : 'Close'
                    });
                })
                .getSystemConfig();
        }

        function renderSystemSettingsForm(config) {
            const contentArea = document.getElementById('contentArea');

            // Generate calendar for current year and next year (2 years total)
            const currentYear = new Date().getFullYear();
            const nextYear = currentYear + 1;
            const currentThaiYear = currentYear + 543;
            const nextThaiYear = nextYear + 543;

            const months = currentLanguage === 'th'
                ? ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.']
                : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            function generateCalendarForYear(year, thaiYear) {
                let yearCalendarHtml = '';

                for (let month = 0; month < 12; month++) {
                    const firstDay = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;

                    yearCalendarHtml += `
            <div class="bg-white rounded-lg shadow p-3 month-calendar" data-month="${monthKey}">
              <h4 class="font-bold text-center mb-2 text-blue-600">${months[month]} ${thaiYear}</h4>
              <div class="grid grid-cols-7 gap-1 text-xs">
                <div class="text-center text-red-600 font-semibold">‡∏≠‡∏≤</div>
                <div class="text-center font-semibold">‡∏à</div>
                <div class="text-center font-semibold">‡∏≠</div>
                <div class="text-center font-semibold">‡∏û</div>
                <div class="text-center font-semibold">‡∏û‡∏§</div>
                <div class="text-center font-semibold">‡∏®</div>
                <div class="text-center text-blue-600 font-semibold">‡∏™</div>
          `;

                    // Empty cells for days before month starts
                    for (let i = 0; i < firstDay; i++) {
                        yearCalendarHtml += '<div></div>';
                    }

                    // Days of the month
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const isHoliday = config.holidays && config.holidays.includes(dateStr);
                        const dayOfWeek = new Date(year, month, day).getDay();
                        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                        yearCalendarHtml += `
              <div class="text-center p-1 rounded cursor-pointer hover:bg-blue-100 ${isHoliday ? 'bg-red-200 font-bold' : ''} ${isWeekend && !isHoliday ? 'text-gray-400' : ''}" 
                   onclick="toggleHoliday('${dateStr}')" 
                   id="day_${dateStr}">
                ${day}
              </div>
            `;
                    }

                    yearCalendarHtml += '</div></div>';
                }

                return yearCalendarHtml;
            }

            const calendarHtml = `
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="calendarGrid">
          ${generateCalendarForYear(currentYear, currentThaiYear)}
          ${generateCalendarForYear(nextYear, nextThaiYear)}
        </div>
      `;

            contentArea.innerHTML = `
        <div class="space-y-6">
          <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">‚öôÔ∏è ${currentLanguage === 'th' ? '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö' : 'System Settings'}</h2>
            
            <div class="space-y-6">
              <!-- Academic Year -->
              <div>
                <h3 class="text-lg font-bold text-gray-700 mb-3">üìÖ ${currentLanguage === 'th' ? '‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤' : 'Academic Year'}</h3>
                <input type="text" id="academicYear" value="${config.academicYear || ''}" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg" 
                       placeholder="${currentLanguage === 'th' ? '‡πÄ‡∏ä‡πà‡∏ô 2568-2569' : 'e.g., 2568-2569'}" required>
              </div>
              
              <!-- Semesters -->
              <div>
                <h3 class="text-lg font-bold text-gray-700 mb-3">üìö ${currentLanguage === 'th' ? '‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'Semesters'}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-2">${currentLanguage === 'th' ? '‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 1 - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô' : 'Semester 1 - Start'}</label>
                    <input type="month" id="semester1Start" value="${config.semester1Start || ''}" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg semester-input" required>
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-2">${currentLanguage === 'th' ? '‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 1 - ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î' : 'Semester 1 - End'}</label>
                    <input type="month" id="semester1End" value="${config.semester1End || ''}" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg semester-input" required>
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-2">${currentLanguage === 'th' ? '‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 2 - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô' : 'Semester 2 - Start'}</label>
                    <input type="month" id="semester2Start" value="${config.semester2Start || ''}" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg semester-input" required>
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-2">${currentLanguage === 'th' ? '‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 2 - ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î' : 'Semester 2 - End'}</label>
                    <input type="month" id="semester2End" value="${config.semester2End || ''}" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg semester-input" required>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Holiday Calendar -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üóìÔ∏è ${currentLanguage === 'th' ? '‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î' : 'Holiday Calendar'} ${currentThaiYear}-${nextThaiYear}</h3>
            <p class="text-sm text-gray-600 mb-4">
              ${currentLanguage === 'th' ? '‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á) - ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'Click on dates to add/remove holidays (selected dates will be highlighted in red) - Calendar shows only months within semester periods'}
            </p>
            <div id="holidayCalendar">
              ${calendarHtml}
            </div>
          </div>
          
          <!-- Save Button (Outside form, covers everything) -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <button onclick="handleSystemConfigSubmit()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 text-lg">
              üíæ ${currentLanguage === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Save All Settings'}
            </button>
          </div>
        </div>
      `;

            // Store holidays in global variable
            window.selectedHolidays = config.holidays || [];

            // Add event listeners to semester inputs to filter calendar
            setTimeout(() => {
                const semesterInputs = document.querySelectorAll('.semester-input');
                semesterInputs.forEach(input => {
                    input.addEventListener('change', filterCalendarMonths);
                });

                // Initial filter
                filterCalendarMonths();
            }, 100);
        }

        window.toggleHoliday = function (dateStr) {
            if (!window.selectedHolidays) {
                window.selectedHolidays = [];
            }

            const index = window.selectedHolidays.indexOf(dateStr);
            const dayElement = document.getElementById(`day_${dateStr}`);

            if (index > -1) {
                // Remove holiday
                window.selectedHolidays.splice(index, 1);
                dayElement.classList.remove('bg-red-200', 'font-bold');
            } else {
                // Add holiday
                window.selectedHolidays.push(dateStr);
                dayElement.classList.add('bg-red-200', 'font-bold');
            }
        }

        window.filterCalendarMonths = function () {
            const semester1Start = document.getElementById('semester1Start').value;
            const semester1End = document.getElementById('semester1End').value;
            const semester2Start = document.getElementById('semester2Start').value;
            const semester2End = document.getElementById('semester2End').value;

            const allMonthCalendars = document.querySelectorAll('.month-calendar');

            // If no semester dates are set, show all months
            if (!semester1Start && !semester1End && !semester2Start && !semester2End) {
                allMonthCalendars.forEach(calendar => {
                    calendar.style.display = 'block';
                });
                return;
            }

            // Create array of months that should be visible
            const visibleMonths = new Set();

            // Add semester 1 months
            if (semester1Start && semester1End) {
                const start = new Date(semester1Start + '-01');
                const end = new Date(semester1End + '-01');

                let current = new Date(start);
                while (current <= end) {
                    const monthKey = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}`;
                    visibleMonths.add(monthKey);
                    current.setMonth(current.getMonth() + 1);
                }
            }

            // Add semester 2 months
            if (semester2Start && semester2End) {
                const start = new Date(semester2Start + '-01');
                const end = new Date(semester2End + '-01');

                let current = new Date(start);
                while (current <= end) {
                    const monthKey = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}`;
                    visibleMonths.add(monthKey);
                    current.setMonth(current.getMonth() + 1);
                }
            }

            // Show/hide calendar months based on visibility
            allMonthCalendars.forEach(calendar => {
                const monthKey = calendar.getAttribute('data-month');
                if (visibleMonths.has(monthKey)) {
                    calendar.style.display = 'block';
                } else {
                    calendar.style.display = 'none';
                }
            });
        }

        window.handleSystemConfigSubmit = function () {
            // Validate required fields
            const academicYear = document.getElementById('academicYear').value;
            const semester1Start = document.getElementById('semester1Start').value;
            const semester1End = document.getElementById('semester1End').value;
            const semester2Start = document.getElementById('semester2Start').value;
            const semester2End = document.getElementById('semester2End').value;

            if (!academicYear || !semester1Start || !semester1End || !semester2Start || !semester2End) {
                Swal.fire({
                    icon: 'warning',
                    title: currentLanguage === 'th' ? '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' : 'Please Fill All Fields',
                    text: currentLanguage === 'th' ? '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' : 'Please fill in academic year and all semester dates',
                    confirmButtonText: currentLanguage === 'th' ? '‡∏ï‡∏Å‡∏•‡∏á' : 'OK'
                });
                return;
            }

            const configData = {
                academicYear: academicYear,
                semester1Start: semester1Start,
                semester1End: semester1End,
                semester2Start: semester2Start,
                semester2End: semester2End,
                holidays: window.selectedHolidays || []
            };

            showLoading(currentLanguage === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...' : 'Saving all settings...');

            google.script.run
                .withSuccessHandler(function (result) {
                    hideLoading();
                    if (result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: currentLanguage === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : 'Saved Successfully',
                            text: currentLanguage === 'th' ? `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ${configData.holidays.length} ‡∏ß‡∏±‡∏ô)` : `System configuration saved successfully (including ${configData.holidays.length} holidays)`,
                            confirmButtonText: currentLanguage === 'th' ? '‡∏ï‡∏Å‡∏•‡∏á' : 'OK'
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: currentLanguage === 'th' ? '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' : 'Error',
                            text: result.message,
                            confirmButtonText: currentLanguage === 'th' ? '‡∏õ‡∏¥‡∏î' : 'Close'
                        });
                    }
                })
                .withFailureHandler(function (error) {
                    hideLoading();
                    Swal.fire({
                        icon: 'error',
                        title: currentLanguage === 'th' ? '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' : 'Error',
                        text: error,
                        confirmButtonText: currentLanguage === 'th' ? '‡∏õ‡∏¥‡∏î' : 'Close'
                    });
                })
                .saveSystemConfig(configData);
        }

        function loadParentMeetingsPage() {
            showLoading();
            google.script.run.withSuccessHandler(function (meetings) {
                hideLoading();
                renderParentMeetingsTable(meetings);
            }).getPendingParentMeetings();
        }

        // --- REPORTS PAGE ---
        function loadReportsPage() {
            const today = new Date().toISOString().split('T')[0];
            const lastMonth = new Date(new Date().setDate(1)).toISOString().split('T')[0];

            document.getElementById('contentArea').innerHTML = `
    <div class="max-w-7xl mx-auto">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä ${currentLanguage === 'th' ? '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' : 'System Reports'}</h2>
        
        <!-- Controls -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6 border border-gray-100">
            <div class="flex flex-col md:flex-row gap-4 items-end">
                <div class="w-full md:w-auto">
                    <label class="block text-xs font-bold text-gray-500 mb-1">${currentLanguage === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô' : 'Start Date'}</label>
                    <input type="date" id="reportStartDate" value="${lastMonth}" class="border p-2 rounded-lg w-full md:w-48 bg-gray-50">
                </div>
                <div class="w-full md:w-auto">
                    <label class="block text-xs font-bold text-gray-500 mb-1">${currentLanguage === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î' : 'End Date'}</label>
                    <input type="date" id="reportEndDate" value="${today}" class="border p-2 rounded-lg w-full md:w-48 bg-gray-50">
                </div>
                <div class="w-full md:w-auto flex gap-2">
                    <button onclick="setReportRange('thisMonth')" class="px-3 py-2 text-xs bg-gray-100 hover:bg-gray-200 rounded text-gray-600 font-semibold transition">This Month</button>
                    <button onclick="setReportRange('lastMonth')" class="px-3 py-2 text-xs bg-gray-100 hover:bg-gray-200 rounded text-gray-600 font-semibold transition">Last Month</button>
                    <button onclick="generateSystemReport()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow flex-grow md:flex-grow-0 ml-auto">
                        ${currentLanguage === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô' : 'Generate Report'}
                    </button>
                </div>
            </div>
        </div>

        <div id="reportResultsArea">
            <!-- Placeholders for Charts -->
            <div class="text-center py-20 text-gray-400">
                 <p>Select a date range and click Generate Report</p>
            </div>
        </div>
    </div>
    `;
            generateSystemReport();
        }

        window.setReportRange = function (range) {
            const date = new Date();
            const endDate = date.toISOString().split('T')[0];
            let startDate;

            if (range === 'thisMonth') {
                startDate = new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
            } else if (range === 'lastMonth') {
                startDate = new Date(date.getFullYear(), date.getMonth() - 1, 1).toISOString().split('T')[0];
                // End date should be last day of last month for accuracy, but today works for general context often. 
                // Let's be precise:
                const lastDayLastMonth = new Date(date.getFullYear(), date.getMonth(), 0).toISOString().split('T')[0];
                document.getElementById('reportEndDate').value = lastDayLastMonth;
                document.getElementById('reportStartDate').value = startDate;
                generateSystemReport();
                return;
            }

            document.getElementById('reportStartDate').value = startDate;
            document.getElementById('reportEndDate').value = endDate;
            generateSystemReport();
        }

        function createLatenessFilter() {
            const today = new Date().toISOString().split('T')[0];
            return { classIds: currentUser.assignedClasses ? currentUser.assignedClasses.split(',') : [], date: today, status: 'Pending' };
        }

        function showToast(title, message, type = 'info') {
            const colors = { error: 'bg-red-600', success: 'bg-green-600', warning: 'bg-yellow-600', info: 'bg-blue-600' };
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 text-white ${colors[type]}`;
            toast.innerHTML = `<div class="font-bold">${title}</div><div class="text-xs">${message}</div>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }



        // --- BEHAVIOR SCOREBOARD ---
        function loadBehaviorScoreboard() {
            showLoading();
            document.getElementById('pageTitle').textContent = currentLanguage === 'th' ? '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏û‡∏§‡∏ï‡∏¥' : 'Behavior Scoreboard';

            google.script.run.withSuccessHandler(function (data) {
                hideLoading();
                const contentArea = document.getElementById('contentArea');

                if (!data || data.length === 0) {
                    contentArea.innerHTML = `<div class="p-8 text-center text-gray-500">No data available for your classes.</div>`;
                    return;
                }

                let rows = data.map(s => {
                    let scoreClass = s.score >= 80 ? 'text-green-600 font-bold' : (s.score >= 50 ? 'text-yellow-600 font-bold' : 'text-red-600 font-bold');
                    return `
            <tr class="hover:bg-gray-50 border-b border-gray-100">
                <td class="p-4">${s.id}</td>
                <td class="p-4">${s.name}</td>
                <td class="p-4 text-center">${s.class}</td>
                <td class="p-4 text-center ${scoreClass} text-lg">${s.score}</td>
            </tr>`;
                }).join('');

                contentArea.innerHTML = `
        <div class="max-w-5xl mx-auto bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                <h2 class="font-bold text-gray-700">Student Behavior Scores</h2>
                <div class="text-xs text-gray-400">Class: ${currentUser.assignedClasses}</div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                            <th class="p-4">ID</th>
                            <th class="p-4">Name</th>
                            <th class="p-4 text-center">Class</th>
                            <th class="p-4 text-center">Score</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        </div>`;
            }).getClassScores(currentUser.assignedClasses);
        }

        // --- HRT LATENESS MANAGEMENT ---
        function loadManageLatenessPage() {
            showLoading();
            document.getElementById('pageTitle').textContent = currentLanguage === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢' : 'Manage Lateness';

            // Create filter for Pending latenesses
            const filter = {
                classIds: currentUser.assignedClasses.split(','),
                date: new Date().toISOString().split('T')[0], // Default to today/recent or just fetch all pending?
                // Actually backend filter might be better, but let's reuse getLatenessRecords
                // and filter client side for 'Pending' status if possible
                // But getLatenessRecords doesn't return status... 
                // Wait, lateness records don't have separate approval status in Lateness_Log except recordType?
                // Ah, HRT Verification is for Level 1 CDRs auto-generated.
                // BUT the requirement says "HRT Lateness Management". 
                // Let's assume this means reviewing the Latenesses that *caused* the CDRs or just general review.
                // Actually, let's look at `approveLateness` in Code.js.
                // It updates Lateness_Log status.
            };

            // We need a specific getter for "Pending Lateness" if we want to approve them.
            // Let's use getLatenessRecords and check if we need to filter.
            // Actually, `approveLateness` implies there is a process.
            // Let's assume we fetch ALL and filter for ones needing review, or just show the log.
            // Re-reading task: "HRT Lateness Management (loadManageLatenessPage)".

            // Fixed Filter: Pending Lateness Only
            const hrtFilter = {
                classIds: currentUser.assignedClasses.split(','),
                status: 'Pending'
            };

            google.script.run
                .withSuccessHandler(function (response) {
                    hideLoading();
                    if (response.success) {
                        renderManageLatenessTable(response.data, currentUser.assignedClasses.split(','));
                    } else {
                        // Handle Error
                        const contentArea = document.getElementById('contentArea');
                        contentArea.innerHTML = `
                            <div class="bg-red-50 p-6 rounded-lg text-center text-red-700 border border-red-200">
                                <h3 class="font-bold text-lg">Error Loading Records</h3>
                                <p>${response.message}</p>
                            </div>`;
                    }
                })
                .withFailureHandler(function (err) {
                    hideLoading();
                    Swal.fire('Error', err.toString(), 'error');
                })
                .getPendingLatenessForHRT(hrtFilter);
        }


        function renderManageLatenessTable(records, classIds, debugInfo) {
            const contentArea = document.getElementById('contentArea');

            // 1. Handle Empty State
            if (!records || records.length === 0) {
                contentArea.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                        <div class="text-4xl mb-4">‚úÖ</div>
                        <h3 class="text-lg font-bold text-gray-600">
                            ${currentLanguage === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : 'No Pending Lateness'}
                        </h3>
                        <p class="text-gray-500 text-sm mt-2">
                            ${currentLanguage === 'th' ? '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏°‡∏≤‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : 'All students are on time or processed.'}
                        </p>
                    </div>`;
                return;
            }

            // 2. Sort by Date/Time (Newest First)
            records.sort((a, b) => {
                // Combine Date + Time strings for reliable sorting
                // format: yyyy-MM-dd + HH:mm
                const dtA = (a.date || '') + 'T' + (a.time || '');
                const dtB = (b.date || '') + 'T' + (b.time || '');
                return dtB.localeCompare(dtA);
            });

            let tableRows = '';

            records.forEach((record) => {
                // Determine Display Date
                let displayDate = record.date;
                try {
                    displayDate = new Date(record.date).toLocaleDateString(currentLanguage === 'th' ? 'th-TH' : 'en-GB', {
                        day: 'numeric', month: 'short', year: 'numeric'
                    });
                } catch (e) { }

                // Determine Action Buttons based on Record Type
                let actionButtons = '';

                if (record.recordType === '8:00' || record.recordType === 'Real Late') {
                    // REAL LATE: Needs Acknowledge (Level 1 Warning) or Create CDR (Punishment)
                    actionButtons = `
                        <div class="flex flex-col sm:flex-row gap-2 justify-center">
                            <button onclick="approveLateness('${record.id}', true)" 
                                class="bg-green-100 text-green-700 px-3 py-1.5 rounded-lg border border-green-200 hover:bg-green-200 text-xs font-bold transition flex items-center justify-center gap-1">
                                ‚úÖ ${currentLanguage === 'th' ? '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö' : 'Acknowledge'}
                            </button>
                            <button onclick="createCDRFromLateness('${record.id}', '${record.studentId}', '${record.studentName}', '${record.class}')" 
                                class="bg-red-100 text-red-700 px-3 py-1.5 rounded-lg border border-red-200 hover:bg-red-200 text-xs font-bold transition flex items-center justify-center gap-1">
                                üìù ${currentLanguage === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á CDR' : 'Create CDR'}
                            </button>
                        </div>`;
                } else {
                    // ACTIVITY LATE (7:40): Log Action (Count-based logic handled in backend/modal)
                    actionButtons = `
                        <button onclick="showLogActionModal('${record.id}', '${record.studentName}', ${record.strikeCount})" 
                            class="bg-blue-100 text-blue-700 px-4 py-1.5 rounded-lg border border-blue-200 hover:bg-blue-200 text-xs font-bold transition flex items-center justify-center gap-1 w-full sm:w-auto">
                            üî® ${currentLanguage === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£' : 'Log Action'}
                        </button>`;
                }

                // Render Row
                tableRows += `
                <tr class="border-b hover:bg-blue-50 transition duration-150">
                    <td class="py-4 px-4 text-sm whitespace-nowrap text-gray-600">${displayDate}</td>
                    <td class="py-4 px-4 text-center">
                        <span class="bg-blue-100 text-blue-700 font-bold px-2 py-1 rounded text-xs">${record.time}</span>
                    </td>
                    <td class="py-4 px-4">
                        <div class="font-bold text-gray-800">${record.studentName}</div>
                        <div class="text-xs text-gray-500">${record.class || '-'} (${record.studentId})</div>
                    </td>
                    <td class="py-4 px-4">
                        <div class="text-gray-700 bg-yellow-50 px-2 py-1 rounded border border-yellow-100 text-sm inline-block">
                           "${record.reason || '-'}"
                        </div>
                    </td>
                    <td class="py-4 px-4 text-center">
                        ${record.recordType !== 'Real Late' && record.recordType !== '8:00'
                        ? `<span class="font-bold ${record.strikeCount >= 3 ? 'text-red-600' : 'text-orange-500'} bg-gray-100 px-2 py-1 rounded-full text-xs">${record.strikeCount}/3</span>`
                        : '<span class="text-gray-300">-</span>'}
                    </td>
                    <td class="py-4 px-4 text-center align-middle">
                        ${actionButtons}
                    </td>
                </tr>`;
            });

            contentArea.innerHTML = `
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">‚è±Ô∏è ${currentLanguage === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢' : 'Manage Lateness'}</h2>
                    <p class="text-gray-500 text-sm mt-1">Review pending lateness records and take action.</p>
                </div>
                <div class="text-right">
                    <span class="bg-red-100 text-red-800 text-xs font-bold px-3 py-1 rounded-full animate-pulse">
                        ${records.length} Pending
                    </span>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="py-3 px-4 text-left font-bold text-gray-500 text-xs uppercase tracking-wider w-32">Date</th>
                                <th class="py-3 px-4 text-center font-bold text-gray-500 text-xs uppercase tracking-wider w-24">Time</th>
                                <th class="py-3 px-4 text-left font-bold text-gray-500 text-xs uppercase tracking-wider">Student</th>
                                <th class="py-3 px-4 text-left font-bold text-gray-500 text-xs uppercase tracking-wider w-1/3">Reason</th>
                                <th class="py-3 px-4 text-center font-bold text-gray-500 text-xs uppercase tracking-wider w-20">Strike</th>
                                <th class="py-3 px-4 text-center font-bold text-gray-500 text-xs uppercase tracking-wider w-64">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            </div>`;
        }

        function handleResolveClick(cdrId, studentName) {
            Swal.fire({
                title: '‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤',
                text: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${studentName}`,
                input: 'textarea',
                showCancelButton: true,
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
            }).then(res => {
                if (res.isConfirmed) {
                    showLoading();
                    google.script.run.withSuccessHandler(() => { hideLoading(); loadMyClassCDR(); }).resolveCDR(cdrId, res.value, currentUser.username);
                }
            });
        }


        function generateSystemReport() {
            const start = document.getElementById('reportStartDate').value;
            const end = document.getElementById('reportEndDate').value;
            google.script.run.withSuccessHandler(renderReportData).getSystemReportData(start, end, currentUser.role, currentUser.assignedClasses);
        }

        // --- REPORT RENDERING (Chart.js) ---
        function renderReportData(stats) {
            const area = document.getElementById('reportResultsArea');

            // SAFEGUARDS: Ensure stats exist (handle empty defaults if needed)
            stats = stats || { totalCDR: 0, level1: 0, level2: 0, totalLateness: 0, topOffenses: [], topClasses: [], activityLate: 0, realLate: 0 };

            area.innerHTML = `
        <!-- KPI CARDS -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div><p class="text-xs text-gray-500 font-bold uppercase tracking-wide">Total CDR</p><p class="text-3xl font-bold text-gray-800 mt-1">${stats.totalCDR}</p></div>
                <div class="p-3 bg-blue-50 text-blue-600 rounded-lg text-xl">üìù</div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div><p class="text-xs text-gray-500 font-bold uppercase tracking-wide">Lateness</p><p class="text-3xl font-bold text-gray-800 mt-1">${stats.totalLateness}</p></div>
                <div class="p-3 bg-orange-50 text-orange-600 rounded-lg text-xl">‚è∞</div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div><p class="text-xs text-gray-500 font-bold uppercase tracking-wide">Level 1</p><p class="text-3xl font-bold text-gray-800 mt-1">${stats.level1}</p></div>
                <div class="p-3 bg-yellow-50 text-yellow-600 rounded-lg text-xl">‚ö†Ô∏è</div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div><p class="text-xs text-gray-500 font-bold uppercase tracking-wide">Level 2</p><p class="text-3xl font-bold text-gray-800 mt-1">${stats.level2}</p></div>
                <div class="p-3 bg-red-50 text-red-600 rounded-lg text-xl">üö®</div>
            </div>
        </div>

        <!-- CHARTS GRID -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            
            <!-- Top Offenses (Bar) -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-4 text-sm uppercase">üìå Top 5 Common Offenses</h3>
                <div class="relative h-64"><canvas id="chartOffenses"></canvas></div>
            </div>

            <!-- Offense Levels (Doughnut) -->
             <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-4 text-sm uppercase">‚öñÔ∏è Severity Distribution</h3>
                <div class="relative h-64 flex justify-center"><canvas id="chartLevels"></canvas></div>
            </div>

            <!-- Lateness Breakdown (Pie) -->
             <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-4 text-sm uppercase">‚è≥ Lateness Type Analysis</h3>
                <div class="relative h-64 flex justify-center"><canvas id="chartLateness"></canvas></div>
            </div>

            <!-- Top Classes (Bar) -->
             <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-4 text-sm uppercase">üè´ Most Frequent Classes</h3>
                <div class="relative h-64"><canvas id="chartClasses"></canvas></div>
            </div>
        </div>
        `;

            // --- INITIALIZE CHARTS ---

            // 1. Offenses
            new Chart(document.getElementById('chartOffenses'), {
                type: 'bar',
                data: {
                    labels: stats.topOffenses.map(x => x.label),
                    datasets: [{
                        label: 'Count',
                        data: stats.topOffenses.map(x => x.count),
                        backgroundColor: '#3B82F6',
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true, grid: { display: false } }, y: { grid: { display: false } } }
                }
            });

            // 2. Severity
            new Chart(document.getElementById('chartLevels'), {
                type: 'doughnut',
                data: {
                    labels: ['Level 1 (General)', 'Level 2 (Serious)'],
                    datasets: [{
                        data: [stats.level1, stats.level2],
                        backgroundColor: ['#F59E0B', '#EF4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // 3. Lateness
            new Chart(document.getElementById('chartLateness'), {
                type: 'pie',
                data: {
                    labels: ['Activity Late (7:40)', 'Real Late (8:00)'],
                    datasets: [{
                        data: [stats.activityLate || 0, stats.realLate || 0],
                        backgroundColor: ['#F97316', '#DC2626'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // 4. Classes
            new Chart(document.getElementById('chartClasses'), {
                type: 'bar',
                data: {
                    labels: stats.topClasses.map(x => x.label),
                    datasets: [{
                        label: 'Incidents',
                        data: stats.topClasses.map(x => x.count),
                        backgroundColor: '#6366F1',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: '#f3f4f6' } }, x: { grid: { display: false } } }
                }
            });
        }

        function approveLateness(id, isAcceptable) {
            showLoading();
            google.script.run.withSuccessHandler(() => { hideLoading(); loadManageLatenessPage(); }).approveLateness(id, isAcceptable);
        }

        function createCDRFromLateness(lId, sId, sName, sClass) {
            Swal.fire({ title: '‡∏™‡∏£‡πâ‡∏≤‡∏á CDR Level 1?', text: `‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á ${sName}`, showCancelButton: true }).then(res => {
                if (res.isConfirmed) {
                    showLoading();
                    google.script.run.withSuccessHandler(() => { hideLoading(); loadManageLatenessPage(); }).createCDRFromLateness(lId, sId, sName, sClass, currentUser.fullName);
                }
            });
        }

        function renderParentMeetingsTable(meetings) {
            let html = meetings.map(m => {
                let statusBadge = m.status === 'Scheduled'
                    ? `<span class="bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded">üìÖ Scheduled: ${m.meetingTime}</span>`
                    : `<span class="bg-yellow-100 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded">‚ö†Ô∏è Approved (Pending Schedule)</span>`;

                let buttons = '';
                if (m.status === 'Approved' || !m.status || m.status === 'Active') {
                    // Show Schedule Button
                    buttons = `<button onclick="scheduleMeeting('${m.cdrId}', '${m.studentName}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">üìÖ Schedule / ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</button>`;
                } else if (m.status === 'Scheduled') {
                    // Show Reschedule and Complete Buttons
                    buttons = `
                        <button onclick="scheduleMeeting('${m.cdrId}', '${m.studentName}')" class="bg-gray-100 text-gray-700 px-3 py-1 rounded text-sm border hover:bg-gray-200">üîÑ Reschedule</button>
                        <button onclick="updateMeetingStatus('${m.cdrId}', 'Completed')" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">‚úÖ Complete / ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
                    `;
                }

                return `
                <div class="bg-white p-4 rounded-lg shadow mb-4 border-l-4 ${m.status === 'Scheduled' ? 'border-blue-500' : 'border-yellow-500'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">${m.studentName} <span class="text-sm font-normal text-gray-500">(${m.class})</span></h3>
                            <div class="mt-1">${statusBadge}</div>
                            <p class="text-sm text-gray-600 mt-2"><strong>Reason:</strong> ${m.reason}</p>
                        </div>
                        <div class="flex flex-col gap-2">
                            ${buttons}
                        </div>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">ü§ù ‡∏ô‡∏±‡∏î‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á (Parent Meetings)</h2>
                    ${html || '<div class="text-center p-8 bg-gray-50 rounded text-gray-500">No pending meetings.</div>'}
                </div>`;
        }

        function scheduleMeeting(id, name) {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢', input: 'datetime-local' }).then(res => {
                if (res.isConfirmed) updateMeetingStatus(id, 'Scheduled', res.value);
            });
        }

        function updateMeetingStatus(id, status, time = null) {
            showLoading();
            google.script.run.withSuccessHandler(() => { hideLoading(); loadParentMeetingsPage(); }).updateParentMeetingStatus(id, status, time);
        }

        // --- VP PENDING APPROVALS PAGE ---
        function loadPendingApprovalsPage() {
            showLoading(currentLanguage === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...' : 'Loading...');
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">‚úÖ ${currentLanguage === 'th' ? '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ô‡∏±‡∏î‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á' : 'Pending Parent Meeting Approvals'}</h2>
                    <p class="text-gray-500 text-sm mt-1">${currentLanguage === 'th' ? '‡∏î‡∏π‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ô‡∏±‡∏î‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å HRT' : 'Review and approve parent meeting requests sent from HRTs.'}</p>
                </div>
                <div id="approvalsTableContainer" class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
                    <div class="p-4 text-center text-gray-500">${currentLanguage === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...' : 'Loading data...'}</div>
                </div>
            `;

            // Fetch the pending approvals
            google.script.run
                .withSuccessHandler(renderPendingApprovalsTable)
                .withFailureHandler(function (error) {
                    hideLoading();
                    document.getElementById('approvalsTableContainer').innerHTML = `
                        <div class="p-4 bg-red-100 text-red-700 rounded-lg">
                            ${currentLanguage === 'th' ? '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : 'Error loading data'}: ${error}
                        </div>
                    `;
                })
                .getPendingApprovals(currentUser.assignedClasses);
        }

        function renderPendingApprovalsTable(requests) {
            hideLoading();
            const container = document.getElementById('approvalsTableContainer');

            if (!requests || requests.length === 0) {
                container.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        ${currentLanguage === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ô‡∏±‡∏î‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : 'No pending parent meeting requests.'}
                    </div>
                `;
                return;
            }

            let html = `
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="py-3 px-4 text-left font-bold text-gray-500 text-xs uppercase tracking-wider">${currentLanguage === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
                                <th class="py-3 px-4 text-left font-bold text-gray-500 text-xs uppercase tracking-wider">${currentLanguage === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠' : 'Student'}</th>
                                <th class="py-3 px-4 text-left font-bold text-gray-500 text-xs uppercase tracking-wider">${currentLanguage === 'th' ? '‡∏´‡πâ‡∏≠‡∏á' : 'Class'}</th>
                                <th class="py-3 px-4 text-left font-bold text-gray-500 text-xs uppercase tracking-wider">${currentLanguage === 'th' ? '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•' : 'Reason'}</th>
                                <th class="py-3 px-4 text-left font-bold text-gray-500 text-xs uppercase tracking-wider">${currentLanguage === 'th' ? '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : 'Action'}</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
            `;

            requests.forEach(req => {
                const dateStr = new Date(req.requestedDate).toLocaleDateString();
                html += `
                    <tr>
                        <td class="py-3 px-4">${dateStr}</td>
                        <td class="py-3 px-4">${req.studentName} (${req.studentId})</td>
                        <td class="py-3 px-4">${req.class}</td>
                        <td class="py-3 px-4">${req.description}</td>
                        <td class="py-3 px-4">
                            <button onclick="approveMeeting('${req.id}', '${req.studentName}')" class="bg-green-100 text-green-700 px-3 py-1 rounded border border-green-300 hover:bg-green-200 text-sm mr-2">
                                ‚úÖ ${currentLanguage === 'th' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : 'Approve'}
                            </button>
                            <button onclick="rejectMeeting('${req.id}', '${req.studentName}')" class="bg-red-100 text-red-700 px-3 py-1 rounded border border-red-300 hover:bg-red-200 text-sm">
                                ‚ùå ${currentLanguage === 'th' ? '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò' : 'Reject'}
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = html;
        }

        function approveMeeting(cdrId, studentName) {
            Swal.fire({
                title: `${currentLanguage === 'th' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : 'Confirm Approval'}`,
                text: `${currentLanguage === 'th' ? '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ô‡∏±‡∏î‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö' : 'Are you sure you want to approve the parent meeting request for'} ${studentName}?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: currentLanguage === 'th' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : 'Approve',
                cancelButtonText: currentLanguage === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading(currentLanguage === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : 'Saving...');
                    google.script.run
                        .withSuccessHandler(() => {
                            hideLoading();
                            Swal.fire(
                                currentLanguage === 'th' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß!' : 'Approved!',
                                currentLanguage === 'th' ? '‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ô‡∏±‡∏î‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : 'The parent meeting request has been approved.',
                                'success'
                            );
                            loadPendingApprovalsPage(); // Refresh the page
                        })
                        .withFailureHandler(function (error) {
                            hideLoading();
                            Swal.fire(
                                currentLanguage === 'th' ? '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' : 'Error',
                                error,
                                'error'
                            );
                        })
                        .approveParentMeeting(cdrId, currentUser.fullName);
                }
            });
        }

        function rejectMeeting(cdrId, studentName) {
            Swal.fire({
                title: `${currentLanguage === 'th' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò' : 'Confirm Rejection'}`,
                text: `${currentLanguage === 'th' ? '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ô‡∏±‡∏î‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö' : 'Are you sure you want to reject the parent meeting request for'} ${studentName}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: currentLanguage === 'th' ? '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò' : 'Reject',
                cancelButtonText: currentLanguage === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading(currentLanguage === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : 'Saving...');
                    google.script.run
                        .withSuccessHandler(() => {
                            hideLoading();
                            Swal.fire(
                                currentLanguage === 'th' ? '‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß!' : 'Rejected!',
                                currentLanguage === 'th' ? '‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ô‡∏±‡∏î‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : 'The parent meeting request has been rejected.',
                                'info'
                            );
                            loadPendingApprovalsPage(); // Refresh the page
                        })
                        .withFailureHandler(function (error) {
                            hideLoading();
                            Swal.fire(
                                currentLanguage === 'th' ? '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' : 'Error',
                                error,
                                'error'
                            );
                        })
                        .rejectParentMeeting(cdrId, currentUser.fullName);
                }
            });
        }

        // Close sidebar logic
        document.addEventListener('click', function (e) {
            const sb = document.getElementById('sidebar');
            if (window.innerWidth < 768 && sb && sb.classList.contains('active') && !sb.contains(e.target) && !e.target.closest('button[onclick="toggleSidebar()"]')) {
                sb.classList.remove('active');
            }
        });
    </script>
</body>

</html>